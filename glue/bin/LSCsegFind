#!/usr/bin/env python2

"""
Client for querying a LSCsegFindServer to find state segments.

Uses pyGlobus and the LSCsegFindClient modules.

$Id$
"""

__version__ = '$Revision$'[11:-2]

import sys
import os
import getopt
import re
import exceptions

try:
  from pyGlobus import security
except ImportError:
  print >> sys.stderr, """
Error: unable to import security module from pyGlobus.

Check that pyGlobus is correctly installed and in your PYTHONPATH.
"""
  sys.exit(1)

# this client should have its PYTHONPATH set for it during installation

PYTHONPATH = os.getenv('PYTHONPATH', None)

try:
  from glue.LSCsegFindClient import LSCsegFindClient
except ImportError:
  print >> sys.stderr, """
Error: unable to import LSCsegFindClient module from glue.

Check that glue is correctly installed and in your PYTHONPATH.
"""
  sys.exit(1)


class LSCsegFindException(exceptions.Exception):
  """
  Exceptions raised by the classes and methods in this client
  will be instances of this class.
  """
  def __init__(self, args=None):
    """
    Create an instance of this class, ie. an LSCSegFindException.

    @param args:

    @return: Instance of class LSCsegFindException
    """
    self.args = args

class LSCsegFind(LSCsegFindClient):
  """
  Class that represents this client interacting with a LSCsegFindServer in
  order to find state segments.
  """
  def __init__(self, host, port):
    """
    Open a connection to a LSCsegFindServer and return an instance of
    class LSCsegFind. One of the public methods can then be called to send a
    request to the server.

    @param host: the host on which the LSCsegFindServer runs
    @type host: string

    @param port: port on which the LSCsegFindServer listens
    @type port: integer


    @return: Instance of LSCsegFindClient
    """
    LSCsegFindClient.__init__(self, host, port)

  def __check_gps(self, gpsString):
    """
    Minimal checking on GPS time strings. Raises a LSCdataFindClientException if
    the GPS time string is not 9 digits long.

    @param gpsString: The string representing the 9 digit GPS time.

    @returns: None
    """
    if len(gpsString) != 9:
      msg = "GPS times must be 9 digits"
      raise LSCsegFindException, msg

    try:
      a = int(gpsString)
    except Exception, e:
      msg = "GPS times must be 9 digits"
      raise LSCsegFindException, msg


  def ping(self, argDict):
    """
    Ping the LSCsegFindServer and print any response sent back.

    @param argDict: Dictionary of arguments passed to all methods.

    @return: None
    """
    response = LSCsegFindClient.ping(self)
    print response

        
  def showInterferometers(self, argDict):
    """
    Query LSCsegFindServer for the distinct values for the 'state_segment.ifo'
    attribute in the metadata table.

    @param argDict: Dictionary of arguments passed to all methods.

    @return: None
    """

    distinctValueList = LSCsegFindClient.distinctAttrValues(self,
      "interferometers")

    for v in distinctValueList:
      print v

  def showTypes(self, argDict):
    """
    Query LSCsegFindServer for the distinct values for the 'state_vec.state'
    attribute in the metadata table.

    @param argDict: Dictionary of arguments passed to all methods.

    @return: None
    """
    distinctValueList = LSCsegFindClient.distinctAttrValues(self, 
      "state")
                
    for v in distinctValueList:
      print v

  def findStateSegments(self, argDict):
    """
    Query the LDRdataFindServer for state segments from a particular
    interferometer, with a particular state type, for a particular range of
    GPS times.

    @param argDict: Dictionary of arguments passed to all methods.

    @return: None
    """
    interferometer = argDict['interferometer']
    type = argDict['type']
    start = argDict['start']
    end = argDict['end']
    type = argDict['type']

    # check that combination of command-line arguments is sound
    if (not interferometer) or (not type) or (not start) or (not end):
      msg = """\
Bad combination of command line arguments:
--interferometer --type --gps-start-time --gps-end-time must all
be present when searching for groups of segments 
"""
      raise LSCsegFindException, msg

    self.__check_gps(start)
    self.__check_gps(end)

    try:
      typeList = type.split(',')
    except:
      msg = "Unable to parse segment type string %s : %s" % (typeString, e)
      raise LSCsegFindException, msg

    query = "state_segment.ifo = '%s' AND (state_vec.state = '%s'" % \
      ( interferometer, typeList.pop(0) )
    for x in typeList:
      query += " OR state_vec.state = '%s'" % (x)
    query += ")"
    
    seglist = LSCsegFindClient.segmentQueryWithMetadata(self,[query])

    if len( seglist ) == 0:
      print >> sys.stderr, "No segments found!"
    else:
      for seg in seglist:
        print seg


def checkCredentials():
    """
    Check to make sure that the proper Grid Credentials (a proxy certificate)
    is available in order to authenticate to the remote LSCsegFindServer.
    """
    # verify that we have access to credentials
    try:
      proxyText = security.grid_proxy_info()
    except Exception, e:
      print >>sys.stderr, "Error verifying credentials: %s" % e
      print >>sys.stderr, \
        "Run 'grid-proxy-init' to generate a proxy certificate"
      sys.exit(1)

    pat = re.compile(r'timeleft : (\d{1,3}):(\d\d):(\d\d)')

    try:
      if isinstance(proxyText, str):
        m = pat.search(proxyText)
      elif isinstance(proxyText, tuple):
        m = pat.search(proxyText[0])
      else:
        raise RuntimeError, "bad format for proxyText in checkCredentials"
      hours, minutes, seconds = map(int, m.groups())

    except Exception, e:
      print >>sys.stderr, "Error parsing proxy information: %s" % e
      sys.exit(1)

    timeleft = seconds + 60 * minutes + 3600 * hours

    if timeleft < 300:
      print >>sys.stderr, "Less than 5 minutes left for proxy certificate."
      print >>sys.stderr, \
        "Run 'grid-proxy-init' to generate a new proxy certificate"
      sys.exit(1)



def usage():
  """
  Print a usage message to stderr.
  """
  msg = """\
NAME
        LSCsegFind

SYNOPSIS
        LSCdataFind --server=NAME:PORT --interferometer=NAME --type=NAME 
               --gps-start-time=GPS --gps-end-time=GPS [ --lfns ] 

        LSCsegFind --server=NAME:PORT --show-interferometers

        LSCsegFind --server=NAME:PORT --show-types

        LSCsegFind --server=NAME:PORT --ping

        LSCsegFind --server=NAME:PORT --version

        LSCsegFind --server=NAME:PORT --help

DESCRIPTION
        Query a LSCsegFindServer to obtain state vector information from a
        certain instrument and of a particular frame type within a GPS range.

        -v, --version
                Print version information for LSCdataFind client

        -i, --interferometer
                interferometer that generated state vector information
                Use --show-interferometers to see what is available

        -t, --type  
                comma separated list of interferometer state types
                Use --show-types to see what is available

        -s, --gps-start-time 
                start of GPS time range

        -e, --gps-end-time   
                end of GPS time range

        -r, --server
                hostname and optional port of server to query, in the form
                host:port

        -w, --show-interferometers
                list available observatory data

        -y, --show-types
                list available types

        -l, --lfns
                show logical file names of the frame files from which
                the state segment information was derived insted of 
                the actual segments

        -p, --ping
                ping the LSCsegFind server

        -h, --help  
                show this usage message

ENVIRONMENT

        LSC_SEGFIND_SERVER can be set to avoid having to use the 
        --server option on the command line. 

EXAMPLE

[dbrown@neutron dbrown]$ LSCsegFind --server ldas-test.ligo.caltech.edu --show-types
Unlocked
Up
Science
Injection
\
"""
  print >>sys.stderr, msg


# grab command line options
shortop = "vi:t:s:e:r:wylph"
longop = [
  "version",
  "interferometer=",
  "type=",
  "gps-start-time=",
  "gps-end-time=",
  "server=",
  "show-interferometers",
  "show-types",
  "lfns",
  "ping",
  "help" ]

try:
  opts, args = getopt.getopt(sys.argv[1:], shortop, longop)
except getopt.GetoptError:
  print >>sys.stderr, "Error parsing command line"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

# defaults
hostPortString = None
port = 49999

clientMethodArgDict = {
  'interferometer': None,
  'type': None,
  'end': None,
  'start': None,
  'lfns': False
}

# default method 
clientMethod = 'findStateSegments'
typeString = None

# environment variables override defaults but not
# command line options
try:
  hostPortString = os.environ['LSC_DATAFIND_SERVER']
except:
  pass

for o, a in opts:
  if o in ("-h", "--help"):
    usage()
    sys.exit(0)
  elif o in ("-v", "--version"):
    print 'LSCsegFind client version', __version__
    import glue.LSCsegFindClient
    print 'Built on top of LSCsegFindClient version', \
      glue.LSCsegFindClient.version()
    sys.exit(0)
  elif o in ("-i", "--interferometer"):
    clientMethodArgDict['interferometer'] = a
  elif o in ("-t", "--type"):
    clientMethodArgDict['type'] = a
  elif o in ("-s", "--gps-start-time"):
    clientMethodArgDict['start'] = a
  elif o in ("-e", "--gps-end-time"):
    clientMethodArgDict['end'] = a
  elif o in ("-r", "--server"):
    hostPortString = a
  elif o in ("-p", "--ping"):
    clientMethod = 'ping'
  elif o in ("-w", "--show-interferometers"):
    clientMethod = 'showInterferometers'
  elif o in ("-y", "--show-types"):
    clientMethod = 'showTypes'
  elif o in ("-l", "--lfns"):
    lfns = True
    clientMethod = 'findStateLFNs'

if not clientMethod:
  print >>sys.stderr, "Bad combination or missing options"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

# determine server and port
if not hostPortString:
  print >>sys.stderr, "No LSCsegFindServer specified"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

if hostPortString.find(':') < 0:
  # no port specified
  host = hostPortString
else:
  # server and port specified
  host, portString = hostPortString.split(':')
  port = int(portString)

# check credentials
checkCredentials()

# open connection to LSCsegFindServer
try:
  myClient = LSCsegFind(host, port)

except Exception, e:
  print >>sys.stderr, \
    "Unable to connect to LSCsegFindServer %s:%d : %s" % (host, port, e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

try:
  eval("myClient.%s(%s)" % (clientMethod, clientMethodArgDict))

except LSCsegFindException, e:
  print >>sys.stderr, str(e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

except Exception, e:
  print >>sys.stderr, "Error querying LSCsegFindServer: %s" % str(e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)
