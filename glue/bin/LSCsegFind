#!/usr/bin/env python2

"""
Client for querying a LSCsegFindServer to find state segments.

Uses pyGlobus and the LSCsegFindClient modules.

$Id$
"""

__version__ = '$Revision$'[11:-2]

import sys
import os
import getopt
import re
import exceptions
from types import *

try:
  from glue import segments
  from glue import LSCsegFindClient
  from glue import gsiserverutils
except ImportError, e:
  print >> sys.stderr, """
Error: unable to import modules from glue.

Check that glue is correctly installed and in your PYTHONPATH.

%s
""" % e
  sys.exit(1)


def usage():
  """
  Print a usage message to stderr.
  """
  msg = """\
NAME
        LSCsegFind

SYNOPSIS
        LSCdataFind --server=NAME:PORT --interferometer=NAME --type=NAME 
               --gps-start-time=GPS --gps-end-time=GPS [ --lfns ] 
               [ --strict-off ] [ --output-format (tcl|python|segwizard) ]

        LSCsegFind --server=NAME:PORT --show-interferometers

        LSCsegFind --server=NAME:PORT --show-types

        LSCsegFind --server=NAME:PORT --ping

        LSCsegFind --server=NAME:PORT --version

        LSCsegFind --server=NAME:PORT --help

DESCRIPTION
        Query a LSCsegFindServer to obtain state vector information from a
        certain instrument and of a particular frame type within a GPS range.

        -v, --version
                Print version information for LSCdataFind client

        -i, --interferometer
                interferometer that generated state vector information
                Use --show-interferometers to see what is available

        -t, --type  
                comma separated list of interferometer state types
                Use --show-types to see what is available

        -s, --gps-start-time 
                start of GPS time range

        -e, --gps-end-time   
                end of GPS time range

        -r, --server
                hostname and optional port of server to query, in the form
                host:port

        -w, --show-interferometers
                list available observatory data

        -y, --show-types
                list available types

        -l, --lfns
                show logical file names of the frame files from which
                the state segment information was derived insted of 
                the actual segments

        -S, --strict-off
                the default behavior is to truncate segments so that 
                returned segments are entirely in the interval
                [gps-start-time, gps-end-time).  However if this option
                is given, the entire non-truncated segment is returned 
                if any part of it overlaps the interval.               

        -o, --output-format (tcl|python|segwizard)
                return the segments as a TCL list, a python list or in
                segwizard format. If not specified the default is two 
                space separated columns containing segment start and 
                end times

        -p, --ping
                ping the LSCsegFind server

        -h, --help  
                show this usage message

ENVIRONMENT

        LSC_SEGFIND_SERVER can be set to avoid having to use the 
        --server option on the command line. 

EXAMPLE

[user@host]$ LSCsegFind --server ldas-test.ligo.caltech.edu --show-types
Unlocked
Up
Science
Injection

[user@host] LSCsegFind --server ldas-test.ligo.caltech.edu --interferometer L1
  --type Science --gps-start-time 700000163 --gps-end-time 700000400
700000163 700000223
700000324 700000400



\
"""
  print >>sys.stderr, msg


# grab command line options
shortop = "vi:t:s:e:r:wySlo:ph"
longop = [
  "version",
  "interferometer=",
  "type=",
  "gps-start-time=",
  "gps-end-time=",
  "server=",
  "show-interferometers",
  "show-types",
  "loose",
  "lfns",
  "strict-off",
  "ping",
  "output-format=",
  "help" ]

try:
  opts, args = getopt.getopt(sys.argv[1:], shortop, longop)
except getopt.GetoptError:
  print >>sys.stderr, "Error parsing command line"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

# defaults
hostPortString = None
port = 30015

clientMethodArgDict = {
  'interferometer': None,
  'type': None,
  'end': None,
  'start': None,
  'lfns': False,
  'strict' : True,
  'format' : None
}

# default method 
clientMethod = 'findStateSegments'
typeString = None

# environment variables override defaults but not
# command line options
try:
  hostPortString = os.environ['LSC_SEGFIND_SERVER']
except:
  pass

for o, a in opts:
  if o in ("-h", "--help"):
    usage()
    sys.exit(0)
  elif o in ("-v", "--version"):
    print 'LSCsegFind client version', __version__
    import glue.LSCsegFindClient
    print 'Built on top of LSCsegFindClient version', \
      glue.LSCsegFindClient.version()
    sys.exit(0)
  elif o in ("-i", "--interferometer"):
    clientMethodArgDict['interferometer'] = a
  elif o in ("-t", "--type"):
    clientMethodArgDict['type'] = a
  elif o in ("-s", "--gps-start-time"):
    clientMethodArgDict['start'] = a
  elif o in ("-e", "--gps-end-time"):
    clientMethodArgDict['end'] = a
  elif o in ("-r", "--server"):
    hostPortString = a
  elif o in ("-p", "--ping"):
    clientMethod = 'ping'
  elif o in ("-w", "--show-interferometers"):
    clientMethod = 'showInterferometers'
  elif o in ("-y", "--show-types"):
    clientMethod = 'showTypes'
  elif o in ("-l", "--lfns"):
    lfns = True
    clientMethod = 'findStateLFNs'
  elif o in ("-S", "--strict-off"):
    clientMethodArgDict['strict'] = False
  elif o in ("-o", "--output-format"):
    clientMethodArgDict['format'] = a

if not clientMethod:
  print >>sys.stderr, "Bad combination or missing options"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

# determine server and port
if not hostPortString:
  print >>sys.stderr, "No LSCsegFindServer specified"
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

if hostPortString.find(':') < 0:
  # no port specified
  host = hostPortString
else:
  # server and port specified
  host, portString = hostPortString.split(':')
  port = int(portString)

# check credentials
gsiserverutils.checkCredentials()

# open connection to LSCsegFindServer
try:
  myClient = LSCsegFindClient.LSCsegFind(host, port)

except Exception, e:
  print >>sys.stderr, \
    "Unable to connect to LSCsegFindServer %s:%d : %s" % (host, port, e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

try:
  eval("result = myClient.%s(%s)" % (clientMethod, clientMethodArgDict))

  if type(result) is StringType:
    print result
  else:
    if len( seglist ) == 0:
      print >> sys.stderr, "No segments found!"
    else:
      if not format:
        for seg in seglist:
          print seg.get_start(), seg.get_end()
      elif format is 'segwizard':
        i = 0
        for seg in seglist:
          print i,seg.get_start(),seg.get_end(),seg.get_end()-seg.get_start()
          i += 1
      elif format is 'tcl' or format is 'python':
        if format is 'tcl':
          ldelim = '{ '
          rdelim = ' }'
          cdelim = ' '
        else:
          ldelim = '['
          rdelim = ']'
          cdelim = ', '
        s = seglist.pop(0)
        print ldelim + ldelim + str(s.get_start()) + cdelim + \
          str(s.get_end()) + rdelim,
        for seg in seglist:
          print cdelim + ldelim + str(seg.get_start()) + cdelim + \
            str(seg.get_end()) + rdelim,
        print rdelim
      else:
        print >> sys.stderr, "Error: unknown segment format : %s" % format
        sys.exit(1)
 
except LSCsegFindException, e:
  print >>sys.stderr, str(e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

except Exception, e:
  print >>sys.stderr, "Error querying LSCsegFindServer: %s" % str(e)
  print >>sys.stderr, "Enter 'LSCsegFind --help' for usage"
  sys.exit(1)

sys.exit(0)
