#!/bin/sh

# function to report failure
fail () {
  echo "!!! 00boot: $1 failed" >&2
  echo "!!! 00boot: consult the file 'README.install' for help" >&2
  exit 1
}

# help message
helpmsg="Usage $0 [options]
Options: [defaults in brackets after description]"
helpmsg="$helpmsg
  --help                        print this message"
helpmsg="$helpmsg
  --with-m4=M4                  use GNU-m4 program M4 [m4]"
helpmsg="$helpmsg
  --with-autoreconf=AUTORECONF  use autoreconf program AUTORECONF [autoreconf]"
helpmsg="$helpmsg
  --with-aclocal=ACLOCAL        use aclocal program ACLOCAL [aclocal]"
helpmsg="$helpmsg
  --with-autoheader=AUTOHEADER  use autoheader program AUTOHEADER [autoheader]"
helpmsg="$helpmsg
  --with-automake=AUTOMAKE      use automake program AUTOMAKE [automake]"
helpmsg="$helpmsg
  --with-autoconf=AUTOCONF      use autoconf program AUTOCONF [autoconf]"
helpmsg="$helpmsg
  --include-deps                pass option --include-deps to automake [no]"

# process args
verbose="false"
while test $# -gt 0 ; do
  option=$1
  case "$option" in
    -*=*) optarg=`echo "$option" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) optarg= ;;
  esac
  case $option in
    -h | -help | --help ) echo "$helpmsg"; exit 0;;
    -with-m4=* | --with-m4=* ) M4="$optarg";;
    -with-autoreconf=* | --with-autoreconf=* ) AUTORECONF="$optarg";;
    -with-aclocal=* | --with-aclocal=* ) ACLOCAL="$optarg";;
    -with-autoheader=* | --with-autoheader=* ) AUTOHEADER="$optarg";;
    -with-automake=* | --with-automake=* ) AUTOMAKE="$optarg";;
    -with-autoconf=* | --with-autoconf=* ) AUTOCONF="$optarg";;
    *) echo "unrecognized option $option"; exit 1;;
  esac
  shift
done

# check autotools versions
echo "00boot: checking versions of autotools"
M4=${M4:-"m4"}
AUTORECONF=${AUTORECONF:-"autoreconf"}
ACLOCAL=${ACLOCAL:-"aclocal"}
AUTOHEADER=${AUTOHEADER:-"autoheader"}
AUTOMAKE=${AUTOMAKE:-"automake"}
AUTOCONF=${AUTOCONF:-"autoconf"}
autoreconf_version="`$AUTORECONF --version 2>/dev/null | sed -n '1s/^.* \([0-9.]*\)/\1/p'`"
aclocal_version="`$ACLOCAL --version 2>/dev/null | sed -n '1s/^.* \([0-9.]*\)/\1/p'`"
autoheader_version="`$AUTOHEADER --version 2>/dev/null | sed -n '1s/^.* \([0-9.]*\)/\1/p'`"
automake_version="`$AUTOMAKE --version 2>/dev/null | sed -n '1s/^.* \([0-9.]*\)/\1/p'`"
autoconf_version="`$AUTOCONF --version 2>/dev/null | sed -n '1s/^.* \([0-9.]*\)/\1/p'`"
if test -z "$autoreconf_version"; then
  fail "finding program autoreconf"
fi
if test -z "$aclocal_version"; then
  fail "finding program aclocal"
fi
if test -z "$autoheader_version"; then
  fail "finding program autoheader"
fi
if test -z "$automake_version"; then
  fail "finding program automake"
fi
if test -z "$autoconf_version"; then
  fail "finding program autoconf"
fi

# report autotools versions
echo "00boot: using:"
printf "00boot:\t%-16s %s\n" "autoreconf-$autoreconf_version:" "`which $AUTORECONF`"
printf "00boot:\t%-16s %s\n" "aclocal-$aclocal_version:" "`which $ACLOCAL`"
printf "00boot:\t%-16s %s\n" "autoheader-$autoheader_version:" "`which $AUTOHEADER`"
printf "00boot:\t%-16s %s\n" "automake-$automake_version:" "`which $AUTOMAKE`"
printf "00boot:\t%-16s %s\n" "autoconf-$autoconf_version:" "`which $AUTOCONF`"

# run m4 to generate sources
echo "00boot: creating sources"

cd packages/std/src || fail "creating sources in packages/std/src"
${M4} Grid.m4 > Grid.c || fail "creating sources in packages/std/src"
cd ../../.. || fail "creating sources in packages/std/src"

cd packages/support/src || fail "creating sources in packages/support/src"
${M4} PrintVector.m4 > PrintVector.c || fail "creating sources in packages/support/src"
${M4} PrintTimeSeries.m4 > PrintTimeSeries.c || fail "creating sources in packages/support/src"
${M4} PrintFrequencySeries.m4 > PrintFrequencySeries.c || fail "creating sources in packages/support/src"
${M4} ReadFrequencySeries.m4 > ReadFrequencySeries.c || fail "creating sources in packages/support/src"
${M4} ReadTimeSeries.m4 > ReadTimeSeries.c || fail "creating sources in packages/support/src"
${M4} StreamVectorInput.m4 > StreamVectorInput.c || fail "creating sources in packages/support/src"
${M4} StreamVectorSequenceInput.m4 > StreamVectorSequenceInput.c || fail "creating sources in packages/support/src"
${M4} StreamSequenceInput.m4 > StreamSequenceInput.c || fail "creating sources in packages/support/src"
${M4} StreamSeriesInput.m4 > StreamSeriesInput.c || fail "creating sources in packages/support/src"
${M4} StreamSeriesOutput.m4 > StreamSeriesOutput.c || fail "creating sources in packages/support/src"
${M4} StreamGridInput.m4 > StreamGridInput.c || fail "creating sources in packages/support/src"
${M4} StreamGridOutput.m4 > StreamGridOutput.c || fail "creating sources in packages/support/src"
cd ../../.. || fail "creating sources in packages/support/src"

cd packages/factories/src || fail "creating sources in packages/factories/src"
${M4} VectorFactories.m4 > VectorFactories.c || fail "creating sources in packages/factories/src"
${M4} VectorSequenceFactories.m4 > VectorSequenceFactories.c || fail "creating sources in packages/factories/src"
${M4} ArrayFactories.m4 > ArrayFactories.c || fail "creating sources in packages/factories/src"
${M4} ArraySequenceFactories.m4 > ArraySequenceFactories.c || fail "creating sources in packages/factories/src"
cd ../../..  || fail "creating sources in packages/factories/src"

cd packages/factories/include || fail "creating sources in packages/factories/include"
${M4} SeqFactoriesH.m4 > SeqFactories.h || fail "creating sources in packages/factories/include"
${M4} AVFactoriesH.m4 > AVFactories.h || fail "creating sources in packages/factories/include"
cd ../../.. || fail "creating sources in packages/factories/include"

cd packages/factories/test || fail "creating sources in packages/factories/include"
${M4} VectorFactoriesTest.m4 > VectorFactoriesTest.c || fail "creating sources in packages/factories/test"
${M4} VectorSequenceFactoriesTest.m4 > VectorSequenceFactoriesTest.c || fail "creating sources in packages/factories/test"
${M4} ArrayFactoriesTest.m4 > ArrayFactoriesTest.c || fail "creating sources in packages/factories/test"
${M4} ArraySequenceFactoriesTest.m4 > ArraySequenceFactoriesTest.c || fail "creating sources in packages/factories/test"
cd ../../.. || fail "creating sources in packages/factories/test"

cd packages/vectorops/src || fail "creating sources in packages/vectorops/src"
${M4} MatrixDivide.m4 > MatrixDivide.c || fail "creating sources in packages/vectorops/src"
${M4} MatrixMultiply.m4 > MatrixMultiply.c || fail "creating sources in packages/vectorops/src"
${M4} MatrixPower.m4 > MatrixPower.c || fail "creating sources in packages/vectorops/src"
${M4} MiscMatlab.m4 > MiscMatlab.c || fail "creating sources in packages/vectorops/src"
${M4} VectorIndexRangeC.m4 > VectorIndexRange.c || fail "creating sources in packages/vectorops/src"
cd ../../.. || fail "creating sources in packages/vectorops/src"

cd packages/vectorops/include || fail "creating sources in packages/vectorops/include"
${M4} VectorIndexRangeH.m4 > VectorIndexRange.h || fail "creating sources in packages/vectorops/include"
cd ../../.. || fail "creating sources in packages/vectorops/include"

cd packages/utilities/src || fail "creating sources in packages/vectorops/include"
${M4} MatrixOps.m4 > MatrixOps.c || fail "creating sources in packages/vectorops/src"
cd ../../.. || fail "creating sources in packages/vectorops/include"

cd packages/stats/src || fail "creating sources in packages/stats/src"
${M4} LALMoment.m4 > LALMoment.c || fail "creating sources in packages/stats/src"
cd ../../.. || fail "creating sources in packages/stats/src"

cd packages/framedata/src || fail "creating sources in packages/framedata/src"
${M4} FrameSeries.m4 > FrameSeries.c || fail "creating sources in packages/framedata/src"
cd ../../.. || fail "creating sources in packages/framedata/src"

cd packages/pulsar/test || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh earth98.dat > earth98.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh sun98.dat > sun98.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh earth99.dat > earth99.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh sun99.dat > sun99.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh earth00.dat > earth00.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh sun00.dat > sun00.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh earth01.dat > earth01.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh sun01.dat > sun01.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh earth02.dat > earth02.ilwd || fail "creating sources in packages/pulsar/test"
/bin/sh ephemtoilwd.sh sun02.dat > sun02.ilwd || fail "creating sources in packages/pulsar/test"
cd ../../.. || fail "creating sources in packages/pulsar/test"

cd packages/tools/include || fail "creating sources in packages/tools/include"
${M4} FrequencySeries.m4 > FrequencySeries.h || fail "creating sources in packages/tools/include"
${M4} Sequence.m4 > Sequence.h || fail "creating sources in packages/tools/include"
${M4} TimeSeries.m4 > TimeSeries.h || fail "creating sources in packages/tools/include"
cd ../src || fail "creating sources in packages/tools/src"
${M4} FrequencySeries.m4 > FrequencySeries.c || fail "creating sources in packages/tools/src"
${M4} Sequence.m4 > Sequence.c || fail "creating sources in packages/tools/src"
${M4} TimeSeries.m4 > TimeSeries.c || fail "creating sources in packages/tools/src"
cd ../../.. || fail "creating sources in packages/tools/src"

# generate build system
echo "00boot: running autoreconf"
$AUTORECONF || fail "autoreconf"

# if there is a lalapps subdirectory run 00boot within this directory too
if test -d lalapps ; then
  echo "00boot: running 00boot within lalapps subdir"
  ( cd lalapps && ./00boot )  || fail "lalapps 00boot"
fi

# report success
echo "00boot: success"
echo "
=================================================================

        00boot has been run.

        Now run './configure' with appropriate options
        to configure LAL.

        If you are building LAL for use with LALApps, see
        the LALApps README file for futher instructions

        Otherwise consult the file README.install

================================================================="
