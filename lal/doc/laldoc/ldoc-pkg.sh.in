#!/bin/sh

if test $# -eq 0 -o $# -gt 4
then
  echo "Usage: $0 package [srcdir [top_builddir [top_srcdir]]]"
  echo "Arguments:"
  echo "  package --      name of package file to be laldoced"
  echo "  srcdir --       relative path to source directory containing"
  echo "                  main.tex and package.tex"
  echo "  top_builddir -- relative path to top lal build directory"
  echo "  top_srcdir --   relative path to top lal source directory"
  echo "Default directories (should be relative paths):"
  echo "  srcdir       = ."
  echo "  top_builddir = ../../.."
  echo "  top_srcdir   = srcdir/../../.."
  exit 1
fi

package=$1
blddir=`pwd`

if test $# -ge 2
then
  srcdir=$blddir/$2
else
  srcdir=$blddir
fi

if test $# -ge 3
then
  top_builddir=$blddir/$3
else
  top_builddir=$blddir/../../..
fi

if test $# -eq 4
then
  top_srcdir=$blddir/$4
else
  top_srcdir=$srcdir/../../..
fi


#package=$1
#blddir=$2
#srcdir=$2/$3
#top_builddir=$2/$4
#top_srcdir=$2/$5

adocdir=$top_builddir/doc/autodoc
ldocdir=$top_builddir/doc/laldoc

rm -f $adocdir/$package*
@LN_S@ $srcdir/$package* $adocdir
cp -f $srcdir/main.* $adocdir
if [ ! -r $top_builddir/doc/lal.sty ]; then
  cp -f $top_srcdir/doc/lal.sty $top_builddir/doc/lal.sty
fi

subdirlist="include src test"

for subdir in $subdirlist ; do
  bld_subdir=$blddir/../$subdir
  src_subdir=$srcdir/../$subdir
  cd $src_subdir
  files=*.[ch]
  for file in $files ; do
    cd $src_subdir
    $ldocdir/laldoc $file logfile $adocdir $src_subdir
  done
  mv -f *.tex $adocdir
done

cd $adocdir
@LATEX@ main
@MKIND@ main
@LATEX@ main
@LATEX@ main

rm -f $adocdir/main.tex
mv -f $adocdir/main.* $blddir
