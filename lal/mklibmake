#!/usr/local/bin/bash

deps=1

cd ./packages

cat << EOF > tmpfile
## Process this file with automake to produce Makefile.in
## this file was automatically generated by mklibmake

if MPI
CC=@MPICC@
else
CC=@CC@
endif

lib_LTLIBRARIES = liblal.la

EOF

for package in *
do
  if [ -d $package ] ; then
  if [ $package != "std" -a $package != "templates" -a $package != "CVS" ] ; then
  echo "processing $package..."

    if [ -r ${package}/src/Makefile.am ] ; then
      if `grep -w 'if FRAME' ${package}/src/Makefile.am > /dev/null ` ; then
        echo "if FRAME" >> tmpfile
        deps=0
      fi
      if `grep -w 'if MPI' ${package}/src/Makefile.am > /dev/null ` ; then
        echo "if MPI" >> tmpfile
        deps=0
      fi
      if `grep -w 'if FRAMEANDMPI' ${package}/src/Makefile.am > /dev/null ` ; then
        echo "if FRAMEANDMPI" >> tmpfile
        deps=0
      fi
    fi

    echo "PKG_"`echo $package | tr "[:lower:]" "[:upper:]"`" = \\" >> tmpfile
    for srcfile in $package/src/*.c
    do
      if [ -r $srcfile ] ; then
        echo -n "\$(top_srcdir)/packages/"`echo $srcfile | sed "s/\.c/\.lo/"`" " >> tmpfile
      fi
    done
    echo "" >> tmpfile

    if [ $deps = 0 ] ; then
      echo "else" >> tmpfile
      echo "PKG_"`echo $package | tr "[:lower:]" "[:upper:]"`" = " >> tmpfile
      echo "endif" >> tmpfile
      deps=1
    fi

    echo "" >> tmpfile

  fi
  fi
done

cat << EOF >> tmpfile
liblal_la_SOURCES = LALEmpty.c

EOF

echo -n "liblal_la_LIBADD = " >> tmpfile
for package in *
do
  if [ $package != "std" -a $package != "templates" -a $package != "CVS" ] ; then
  if [ -d $package ] ; then
    echo -n "\$(PKG_"`echo ${package} | tr "[:lower:]" "[:upper:]"`") " >> tmpfile
  fi
  fi
done

mv tmpfile ../lib/Makefile.am
rm -f tmpfile

cd ..

exit 0
