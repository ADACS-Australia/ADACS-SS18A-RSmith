#!/usr/bin/python
#
# $Id$
#
# Copyright (C) 2006  Kipp C. Cannon
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

#
# Add event_id columns to all sngl_burst tables, and assign an ID to each
# trigger.  Reads input from stdin, writes output to stdout.
#

from xml import sax

from glue.ligolw import ligolw
from glue.ligolw import metaio
from glue.ligolw import lsctables


def LoadDocuments():
	doc = ligolw.Document()
	ligolw.make_parser(lsctables.LIGOLWContentHandler(doc)).parse(sys.stdin)
	return doc


def AddEventIDs(doc):
	new_event_ids = lsctables.SnglBurstIDs()
	for table in lsctables.getTablesByType(doc, lsctables.SnglBurstTable):
		table.insertBefore(metaio.Column(sax.xmlreader.AttributesImpl({u"Name": metaio.StripTableName(table.tableName) + ":event_id", u"Type": lsctables.SnglBurstTable.validcolumns["event_id"]})), table.childNodes[-1])
		for row in table.rows:
			row.event_id = new_event_ids.next()
	return doc


AddEventIDs(LoadDocuments()).write()
