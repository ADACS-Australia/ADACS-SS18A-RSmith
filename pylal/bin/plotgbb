#!/usr/bin/python

import sys
import os
from optparse import *
#import getopt
import re
import exceptions
import glob
from types import *

from pylab import *
from pylal import readMeta
from pylal import viz

##############################################################################
# temp "file"
def makeData( max, dx ):
# returns P(x), x, dx
  x  = arange( 0, max, dx )
  return 1.0/( x+1.0 )**2.0, x, dx

##############################################################################
# help message
usage = """\
Usage: plotgbb [options]

  SUMMARY:  
  
  Generate a set of summary plots from triggers stored as simInspiral 
  tables in LIGO lightweight format.  The plots are

    1.
    2.
    3.

"""

##############################################################################
parser = OptionParser( usage )
parser.add_option("-v","--version",action="store_true",default=False,\
    help="display version information " )
parser.add_option("-f","--figure-name",action="store",type="string",\
    default=None,metavar=" FNAME",\
    help="generate ps figures with name FNAME.ps and FNAME_loglog.ps")
parser.add_option("-t","--title",action="store",type="string",default=None,\
    metavar=" STRING",help="title string for plots")
parser.add_option("-s","--show-plot",action="store_true",default=False,\
    help="display the figures on the terminal" )

(opts,args) = parser.parse_args()

# if --version flagged
if opts.version:
  sys.exit(0)

# check at least one trig file was specified
if not args:
  print >>sys.stderr, "at least one trigger file must be specified"
  print >>sys.stderr, "Enter 'plotgbb --help' for usage"
  sys.exit(1)

trigFiles = args

##############################################################################

# an instance of the simInspiralTable
simInspTriggers=readMeta.metaDataTable( trigFiles, "sim_inspiral" )

# make a regular plot.
# The following line determines the number of sources named GBB.
numSources = len( [e for e in simInspTriggers.table if ( re.match("GBB",e["source"]) )] )

h=simInspTriggers.mkarray( "eff_dist_h" )
index=arange( 0, len(h) )*7.45/numSources
hs=sort(h)

l=simInspTriggers.mkarray( "eff_dist_l" )
ls=sort( l )

g=simInspTriggers.mkarray( "eff_dist_g" )
gs=sort( g )

t=simInspTriggers.mkarray( "eff_dist_t" )
ts=sort( t )

v=simInspTriggers.mkarray( "eff_dist_v" )
vs=sort( v )

plot( hs, index, ls, index, gs, index, ts, index, vs, index )
grid( True )
axis( [0, 40, 0, 300] )
xlabel( 'Effective Distance (Mpc)' )
ylabel('N_G' )
legend( ('Hanford', 'Livingston', 'GEO', 'TAMA', 'VIRGO'), loc=0 )
if opts.title:
  title( opts.title )
if opts.figure_name:
  savefig( opts.figure_name + ".ps" )

# make a loglog plot.
figure()
eps=0.00001	# to prevent log(0) craziness.
index=index+eps

loglog( hs, index, ls, index, gs, index, ts, index, vs, index )
grid( True )
axis( [1, 40, 1, 300] )
xlabel( 'Effective Distance (Mpc)' )
ylabel( 'N_G' )
legend( ('Hanford', 'Livingston', 'GEO', 'TAMA', 'VIRGO'), loc=0 )
if opts.title:
  title( opts.title )
if opts.figure_name:
  savefig( opts.figure_name + "_loglog.ps" )


# effective distance plot.
figure()
P_x, x, dx = makeData( 50, 1 )

Ng_h, Ng_l = [], []
# Find the number of galaxies with effective distance close to "i".
for i in x:
  Ng_h.append( len([ e for e in simInspTriggers.table if (-0.5 < e["eff_dist_h"] - i <= 0.5 ) ]) )
  Ng_l.append( len([ e for e in simInspTriggers.table if (-0.5 < e["eff_dist_l"] - i <= 0.5 ) ]) )

plot( x, P_x*Ng_h*dx, x, P_x*Ng_l*dx )
grid( True )
axis( [0, len(x), 0, 1] )
xlabel( 'eff_dist (Mpc)' )
ylabel( 'N_G?' )
legend( ('eff_dist_h', 'eff_dist_l'), loc=0 )
if opts.title:
  title( opts.title )
if opts.figure_name:
  savefig( opts.figure_name + "_temp.ps" )

if opts.show_plot:
  show()
