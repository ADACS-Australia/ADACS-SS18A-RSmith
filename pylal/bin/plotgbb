#!/usr/bin/python

import sys
import os
from optparse import *
#import getopt
import re
import exceptions
import glob
import fileinput
import linecache
import string
from types import *

from pylab import *
from pylal import readMeta
from pylal import viz

#############################################################################################################################################################
f = open('/home/rahul/src/lscsoft/lalapps/src/inspiral/inspsrcs.dat', "r")
lines = f.readlines()


l =[]

i = 1
while i < len(lines):
	a  = linecache.getline('/home/rahul/src/lscsoft/lalapps/src/inspiral/inspsrcs.dat', i)
	b  = string.split(a)
	l.append(b)
	i = i + 1

	
k = []
j = 1
while j < len(lines)-1:
	s = float(l[j][4])
	k.append(l[j][4])
	j = j + 1


d={}
j = 1
while j < len(lines)-1:

	d[float(l[j][4])]=l[j][0]
	j = j + 1

print d[float(max(k))]
 

#############################################################################################################################################################
# Chop a simInspiralTable into segments that we care about.
def getSegments ( sim_table, t_start, t_end, t_seg, t_between_seg ):
# getSegments returns a new simInspiralTable consisting only of sources
# occurring during the specified time intervals.
  t1 = t_start + t_seg
  
  while t1 < t_end:
    t2 = t1 + t_between_seg

    for e in sim_table.table:
      if ( t1 <= e["h_end_time"] <= t2 ):
        sim_table.table.remove( e )

    t1 = t2 + t_seg

  return sim_table


##############################################################################
# temp "file"
def makeData( max, dx ):
# returns P(x), x, dx
  x  = arange( 0, max, dx )
  return 1.0/( x+1.0 )**2.0, x, dx

##############################################################################
# help message
usage = """\
Usage: plotgbb [options]

  SUMMARY:  
  
  Generate a set of summary plots from triggers stored as simInspiral 
  tables in LIGO lightweight format.  The plots are

    1.
    2.
    3.

"""

##############################################################################
parser = OptionParser( usage )
parser.add_option("-v","--version",action="store_true",default=False,\
    help="display version information " )
parser.add_option("-f","--figure-name",action="store",type="string",\
    default=None,metavar=" FNAME",\
    help="generate ps figures with name FNAME_PlotType.ps")
parser.add_option("-t","--title",action="store",type="string",default=None,\
    metavar=" STRING",help="title string for plots")
parser.add_option("-s","--show-plot",action="store_true",default=False,\
    help="display the figures on the terminal" )
parser.add_option("-r","--show-reg",action="store_true",default=False,\
    help="display the _plot.ps figure on the terminal" )
parser.add_option("-l","--show-log",action="store_true",default=False,\
    help="display the loglog.ps figure on the terminal" )
parser.add_option("-b","--show-bar",action="store_true",default=False,\
    help="display the hist.ps figure on the terminal" )
parser.add_option("-u","--show-sum",action="store_true",default=False,\
    help="display the sum_plot.ps figure on the terminal" )



(opts,args) = parser.parse_args()

# if --version flagged
if opts.version:
  sys.exit(0)

# check at least one trig file was specified
if not args:
  print >>sys.stderr, "at least one trigger file must be specified"
  print >>sys.stderr, "Enter 'plotgbb --help' for usage"
  sys.exit(1)

trigFiles = args

##############################################################################
# Constants:
X_MAX = 40	# x-axis max for plots.
Y_MAX = 300	# y-axis max for plots.
L_MAX = float(max(k))	# Luminosity constant.
START_TIME = 799000000
STOP_TIME = 810000000
SEG_LEN = 2.5*8.64*10**4
GAP_LEN = 0.33*8.64*10**4

print L_MAX


# an instance of the simInspiralTable
simInspTriggers=readMeta.metaDataTable( trigFiles, "sim_inspiral" )

# TEST!!!

simInspTriggers = getSegments( simInspTriggers, START_TIME, \
     STOP_TIME, SEG_LEN, GAP_LEN )

#print >> sys.stderr, simInspTriggers

# The following line determines the number of sources with highest luminousity
numSources = len( [e for e in simInspTriggers.table if ( re.match(" d[float(max(k))]",e["source"]) )] )

print >> sys.stderr, numSources

h=simInspTriggers.mkarray( "eff_dist_h" )
index=arange( 0, len(h) )*L_MAX/numSources
hs=sort(h)

l=simInspTriggers.mkarray( "eff_dist_l" )
ls=sort( l )

g=simInspTriggers.mkarray( "eff_dist_g" )
gs=sort( g )

t=simInspTriggers.mkarray( "eff_dist_t" )
ts=sort( t )

v=simInspTriggers.mkarray( "eff_dist_v" )
vs=sort( v )

# make a regular plot.

if opts.show_reg:

	plot( hs, index, ls, index, gs, index, ts, index, vs, index )
	grid( True )
	axis( [	0, X_MAX, 0, Y_MAX] )
	xlabel( 'Effective Distance (Mpc)' )
	ylabel('N_G' )
	legend( ('Hanford', 'Livingston', 'GEO', 'TAMA', 'VIRGO'), loc=0 )
	if opts.title:
	  title( opts.title )
	if opts.figure_name:
	  savefig( opts.figure_name + "_plot.ps" )

	show()


# make a loglog plot.

if opts.show_log:

	figure()
	eps=0.00001	# to prevent log(0) craziness.
	log_i=index+eps
	
	loglog( hs, log_i, ls, log_i, gs, log_i, ts, log_i, vs, log_i )
	grid( True )
	axis( [1, X_MAX, 1, Y_MAX] )
	xlabel( 'Effective Distance (Mpc)' )
	ylabel( 'N_G' )
	legend( ('Hanford', 'Livingston', 'GEO', 'TAMA', 'VIRGO'), loc=0 )
	if opts.title:
	  title( opts.title )
	if opts.figure_name:
	  savefig( opts.figure_name + "_loglog.ps" )
	
	show()

	
# effective distance plot.

if opts.show_bar:

	figure()
	P_x, x, dx = makeData( 50, 1 )
	
	ng,a,b = hist( hs, x )
	grid( True )
	axis( [0, X_MAX, 0, max( ng[0:X_MAX+1] )] )
	xlabel( 'Effective Distance (Mpc)' )
	ylabel('N_G' )
	if opts.title:
	  title( opts.title )
	if opts.figure_name:
	  savefig( opts.figure_name + "_hist.ps" )

	show()


# cumulative sum plot (approximation of first plot)

if opts.show_sum:

	figure()
	P_x, x, dx = makeData( 50, 1)

	ng,a,b = hist( hs, x )
	ng = ng*L_MAX/numSources  	# normalize.
	for i in range(1,len(x)):
	  ng[i] = ng[i-1] + ng[i]
	
	plot( x[0:X_MAX+1], ng[0:X_MAX+1] )
	grid( True )
	axis( [0, X_MAX, 0, Y_MAX] )
	xlabel( 'Effective Distance (Mpc)' )
	ylabel('N_G' )
	if opts.title:
	  title( opts.title )
	if opts.figure_name:
	  savefig( opts.figure_name + "_sum_plot.ps" )

	show()



if opts.show_plot:
  show()

################################
# Segment reading

h_time=simInspTriggers.mkarray( "h_end_time" )




#print >>sys.stderr, h_time


