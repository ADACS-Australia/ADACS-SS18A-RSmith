#!/usr/bin/python

import sys
import glob
from optparse import *
from pylab import *
from pylal import viz
from glue.ligolw import ligolw
from glue.ligolw import table
from glue.ligolw import lsctables

##############################################################################

##############################################################################
# function to read in a list of files
def isSearchSumm(name, attrs):
  return lsctables.IsTableProperties(lsctables.SearchSummaryTable, name, attrs)

def isProcess(name, attrs):
  return lsctables.IsTableProperties(lsctables.ProcessTable, name, attrs)

def readFiles(fList):
  """
  read in the SimInspiralTables from a list of files
  @param fList:       list of input files
  """
  output = {}
  if not fList:
    return output
  for thisFile in fList:
    doc = ligolw.Document()
    # read in ifo from process, as not stored in SearchSumm
    ligolw.make_parser(ligolw.PartialLIGOLWContentHandler(doc, \
        isProcess)).parse(file(thisFile))
    ifo = doc.childNodes[0].getColumnByName('ifos')[0]
    # read in SearchSummary
    doc = ligolw.Document()
    ligolw.make_parser(ligolw.PartialLIGOLWContentHandler(doc, \
        isSearchSumm)).parse(file(thisFile))
    searchSummTable = doc.childNodes[0]
    if output.has_key(ifo):
      output[ifo].extend(searchSummTable)
    else:
      output[ifo] = searchSummTable
  return output


#################################################################
# help message
usage = """\
Usage: plotnumtemplates [options]

  SUMMARY: Makes a plot of the number of templates against time.  The code
           will read in either TMPLTBANK files or TRIGBANK files or both, 
           for as many ifo's as you like.  It will then plot the number of 
           templates vs time for each ifo and each type of bank (TMPLT and 
           TRIG).

"""

##############################################################################
parser = OptionParser( usage )
    
parser.add_option("-t","--tmplt-glob",action="store",type="string",\
    default=None,metavar="TMPLT",\
    help="glob for files containing the string TMPLT")
    
parser.add_option("-T","--trig-glob",action="store",type="string",\
    default=None,metavar="TRIG",\
    help="glob for files containing the string TRIG")
    
parser.add_option("-s","--show-plot",action="store_true",default=False,\
    help="display the figures on the terminal" )

parser.add_option("-f","--figure-name",action="store",type="string",\
    default=None, metavar=" FNAME",\
    help="generate png figures with name FNAME.png" )

parser.add_option("-p","--print-numbers",action="store_true",default=False,\
    help="prints each number on the screen" )

(opts,args) = parser.parse_args()



# identify the template bank files
if opts.tmplt_glob:
  tmpltbankFiles = glob.glob(opts.tmplt_glob)
  if not tmpltbankFiles:
    print >>sys.stderr, "The glob for " + opts.tmplt_glob + \
        " returned no files"
    sys.exit(1)
else:
  tmpltbankFiles = None

# identify the trigbank files
if opts.trig_glob:
  trigbankFiles = glob.glob(opts.trig_glob)
  if not trigbankFiles:
    print >>sys.stderr, "The glob for " + opts.trig_glob + \
        " returned no files"
    sys.exit(1)
else:
  trigbankFiles = None
  
#######################################################################
# Read in the search summaries from the template banks
tmpltSumm = readFiles(tmpltbankFiles)
trigSumm  = readFiles(trigbankFiles)

colors = {'G1':'k','H1':'r','H2':'b','L1':'g'}

for ifo in tmpltSumm.keys():
  numTemplates = tmpltSumm[ifo].getColumnByName('nevents').asarray()
  startTime = viz.timeindays(tmpltSumm[ifo].getColumnByName('out_start_time').asarray())
  style = colors[ifo] + 'x'
  plot(startTime, numTemplates, style, label=ifo+' tmplt',\
      markersize=12, markeredgewidth=1)
  if opts.print_numbers:
    print "Number of templates for :" +ifo+ str(startTime) +" " + str(numTemplates)

for ifo in trigSumm.keys():
  numTrigs = trigSumm[ifo].getColumnByName('nevents').asarray()
  startTime = viz.timeindays(trigSumm[ifo].getColumnByName('out_start_time').asarray())
  style = colors[ifo] + 'o'
  plot(startTime, numTrigs, style, label=ifo+' trig',\
      markersize=12, markeredgewidth=1)
  if opts.print_numbers:
    print "Number templates for :" +ifo+ str(startTime) +" " + str(numTrigs)
      
xlabel('Days after start of run', size='x-large')
ylabel('Number of templates', size='x-large')
legend()
grid("on")
if opts.figure_name:
  savefig(opts.figure_name + ".png")

if opts.show_plot:
  show()  
