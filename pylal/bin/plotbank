#!/usr/bin/python

# $Id$
__author__ = "Drew Keppel <keppel_d@ligo.caltech.edu>"
__version__ = "$Revision$"[11:-2]
__date__ = "$Date$"[7:-2]

import sys
import os
from optparse import *
import re
import exceptions
import glob
from types import *

#import operator
from glue.ligolw import ligolw
from glue.ligolw import table
from pylal import SnglInspiralUtils

##############################################################################
usage = """
usage: %prog [options]

Bank Plotting Function

Generates plots showing the sngl_inspiral mass paramters contain in a file
"""

parser = OptionParser( usage=usage, version="" )
parser.add_option("-T","--template-glob",action="store",type="string",\
    default=None, metavar="TMPLT",\
    help="Glob the list of sngl_inspirals from the template banks" )
parser.add_option("-I","--inspiral-glob",action="store",type="string",\
    default=None, metavar=" INSP",\
    help="Glob the list of sngl_inspirals from the inspirals" )
parser.add_option("-f","--figure-name",action="store",type="string",\
    default=None, metavar=" FNAME",\
    help="generate png figures with name FNAME-fig.png" )
parser.add_option("-m","--m1-m2",action="store_true",default=False,\
    help="make plots of mass2 vs mass1" )
parser.add_option("-M","--mchirp-eta",action="store_true",default=False,\
    help="make plots of eta vs mchirp" )
parser.add_option("-t","--tau0-tau3",action="store_true",default=False,\
    help="make plots of tau3 vs tau0" )
parser.add_option("-x","--x-lim",action="store",type="float",default=None,\
    help="x limit" )
parser.add_option("-y","--y-lim",action="store",type="float",default=None,\
    help="y limit" )
parser.add_option("-i","--inj-time",action="store",type="float",default=None,\
    help="plot templates within 1 sec of injection time" )
parser.add_option("-G","--get-bins",action="store",type="string",default=0,\
    help="plot N bins of equal number of templates" )
parser.add_option("-p","--print-bins",action="store_true",default=False,\
    help="print the bins on the terminal" )
parser.add_option("-s","--show-plot",action="store_true",default=False,\
    help="display the figures on the terminal" )

(opts,args) = parser.parse_args()

# Now, use the Agg backend if it's unnecessary to call plot(), then do imports
if not opts.show_plot:
  import matplotlib
  matplotlib.use('Agg')
from pylab import *

if opts.template_glob:
  file_template = glob.glob(opts.template_glob)
else:
  print >>sys.stderr, "Must specify a glob of template bank files"
  sys.exit(1)


if opts.inspiral_glob:
  file_inspiral = glob.glob(opts.inspiral_glob)
  inspirals = SnglInspiralUtils.ReadSnglInspiralFromFiles(file_inspiral)
else:
  pass



if not (opts.m1_m2 or opts.mchirp_eta or opts.tau0_tau3):
  print >>sys.stderr, "Must specify --m1-m2, --mchirp-eta, or --tau0-tau3"
  sys.exit(1)

# Do the pylab import in such a way that doesn't require an X display
# if show() won't be invoked.
if not opts.show_plot:
  import matplotlib
  matplotlib.use('Agg')
from pylab import *
from pylal import viz
rc('text', usetex=True)

templates = SnglInspiralUtils.ReadSnglInspiralFromFiles(file_template)


if opts.get_bins:
  n_lines = opts.get_bins

  x_bins = []
  for i in range(n_lines):
    x_bins.append(0)
  x_bins.append(0)

  tmplts = []
  for i in range(len(x)):
    tmplts.append((x[i],y[i]))

  tmplts.sort(key=operator.itemgetter(0))

  if get_bins:
    i_break = len(tmplts)//n_lines

    x_break = []
    for i in range(n_lines):
      tmp1, tmp2 = tmplts[i*i_break]
      x_break.append(tmp1)
      x_bins[i] += tmp1
    tmp1, tmp2 = tmplts[len(tmplts)-1]
    x_break.append(tmp1)
    x_bins[n_lines] += tmp1

fig_num = 0
if opts.m1_m2:
  fig_num += 1
  figure(fig_num)
  plot(templates.get_column('mass1'),templates.get_column('mass2'),'bx')
  if opts.inspiral_glob:
    hold(True)
    plot(inspirals.get_column('mass1'),inspirals.get_column('mass2'),'ko')
    legend(('templates','triggers'))
  else:
    legend('templates')
    
  grid()
  title('mass1 and mass2')
  xlabel('mass1')
  ylabel('mass2')

  print len(templates)
  if opts.figure_name:
    savefig(opts.figure_name + '_' + 'm1_and_m2' + '.png')
  if not opts.show_plot:
    close()

if opts.mchirp_eta:
  fig_num += 1
  figure(fig_num)
  plot(templates.get_column('mchirp'),templates.get_column('eta'),'bx')
  if opts.inspiral_glob:
    hold(True)
    plot(inspirals.get_column('mchirp'),inspirals.get_column('eta'),'ko')
    legend(('templates','triggers'))
  else:
    legend('templates')
  
  grid()
  title('mchirp and eta')
  xlabel('mchirp')
  ylabel('eta')

  if opts.figure_name:
    savefig(opts.figure_name + '_' + 'mchirp_and_eta' + '.png')
  if not opts.show_plot:
    close()


if opts.tau0_tau3:
  fig_num += 1
  figure(fig_num)
  plot(templates.get_column('tau0'),templates.get_column('tau3'),'bx', \
    [3.628166],[1.292681],'r1')
  if opts.inspiral_glob:
    hold(True)
    plot(inspirals.get_column('tau0'),inspirals.get_column('tau3'),'kx')
    legend(('templates',' ','triggers'))
  else:
    legend('templates')
  grid()
  if opts.x_lim and opts.y_lim:
    axis([0.0,opts.x_lim,0.0,opts.y_lim])
  title('tau0 and tau3')
  xlabel('tau0')
  ylabel('tau3')
  if opts.figure_name:
    savefig(opts.figure_name + '_tau0_and_tau3' + '.png')
  if not opts.show_plot:
    close()

if opts.inj_time:
  injTemplates = [[],[]]
  for tmplt in templates:
    if abs(tmplt.end_time - opts.inj_time + \
         10**(-9) * tmplt.end_time_ns) < 1.0:
      injTemplates[0].append(tmplt.tau0)
      injTemplates[1].append(tmplt.tau3)
  fig_num += 1
  figure(fig_num)
  plot(injTemplates[0],injTemplates[1],'bx',[3.628166],[1.292681],'r1')
  grid()
  if opts.x_lim and opts.y_lim:
    axis([0.0,opts.x_lim,0.0,opts.y_lim])
  title(file[0] + '\n' + str(int(opts.inj_time)))
  xlabel('tau0')
  ylabel('tau3')
  if opts.figure_name:
    savefig(opts.figure_name + '_' + str(int(opts.inj_time)) + '.png')
  if not opts.show_plot:
    close()

if opts.show_plot:
  show()

#  if get_bins:
#    for i in range(len(x_break)):
#      axvline(x_break[i],linewidth=2,color='k')
#  elif x_break:
#    v = axis()
#    contour_x = []
#    contour_y = []
#    contour_z = []
#    for i in range(101):
#      contour_x.append( (v[1]-v[0])*float(i)/100.0 + v[0] )
#      contour_y.append( (v[3]-v[2])*float(i)/100.0 + v[2] )
#    for i in range(101):
#      contour_z.append([])
#      for j in range(101):
#        contour_z[i].append( ((contour_x[i]*contour_y[j])**(3.0/5.0))/((contour_x[i]+contour_y[j]+0.00001)**(1.0/5.0)) )
#    contour(contour_x,contour_y,contour_z,x_break,linewidths=2,colors='k')
#    axis(v)
#  title(tmplt)
#  xlabel(x_name)
#  ylabel(y_name)
#    savefig(tmplt + file_name_add + '.png')
#  fig_num += 1

#  if get_bins:
#    print len(tmplts)
#    print x_break

#for i in range(len(x_bins)):
#  x_bins[i] /= float(n_names)
