#!/usr/bin/python
#
# Copyright (C) 2009  Kipp Cannon
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.


#
# =============================================================================
#
#                                   Preamble
#
# =============================================================================
#


import bisect
import math
import matplotlib
matplotlib.rcParams.update({
	"font.size": 8.0,
	"axes.titlesize": 10.0,
	"axes.labelsize": 10.0,
	"xtick.labelsize": 8.0,
	"ytick.labelsize": 8.0,
	"legend.fontsize": 8.0,
	"figure.dpi": 300,
	"savefig.dpi": 300,
	"text.usetex": True
})
from matplotlib import figure
from matplotlib import patches
from matplotlib import cm
from matplotlib import colorbar
from matplotlib.backends.backend_agg import FigureCanvasAgg as FigureCanvas
import numpy
from optparse import OptionParser
import sys


from glue.ligolw import ligolw
from glue.ligolw import lsctables
from glue.ligolw import utils
from pylal import git_version
from pylal import rate
from pylal import ligolw_burca_tailor


__author__ = "Kipp Cannon <kipp.cannon@ligo.org>"
__version__ = "git id %s" % git_version.id
__date__ = git_version.date


golden_ratio = (1 + math.sqrt(5)) / 2


#
# =============================================================================
#
#                                 Command Line
#
# =============================================================================
#


def parse_command_line():
	parser = OptionParser(
		version = "Name: %%prog\n%s" % git_version.verbose_msg
	)
	parser.add_option("-v", "--verbose", action = "store_true", help = "Be verbose.")
	options, filenames = parser.parse_args()

	return options, (filenames or [None])


#
# =============================================================================
#
#                                     Blah
#
# =============================================================================
#


def get_coincparamsdistributions(xmldoc):
	coincparamsdistributions, process_id = ligolw_burca_tailor.coinc_params_distributions_from_xml(xmldoc, u"string_cusp_likelihood")
	return coincparamsdistributions


def clip_binned_array_1d(binnedarray, xlim):
	imin, = binnedarray.bins[xlim[0],]
	imax, = binnedarray.bins[xlim[1],]
	coords, = binnedarray.bins.centres()
	return coords[imin:imax], binnedarray.array[imin:imax]


def clip_binned_array_2d(binnedarray, xlim, ylim):
	imin, jmin = binnedarray.bins[xlim[0], ylim[0]]
	imax, jmax = binnedarray.bins[xlim[1], ylim[1]]
	xcoords, ycoords = binnedarray.bins.centres()
	return xcoords[imin:imax], ycoords[jmin:jmax], binnedarray.array[imin:imax,jmin:jmax]


def snr2_chi2_plot(key, background_xcoords, background_ycoords, background_data, injections_xcoords, injections_ycoords, injections_data, ncontours = 9):
	fig = figure.Figure(figsize=(3, 3))
	FigureCanvas(fig)
	axes = fig.add_axes((.15, .15, .95 - .15, .90 - .15))
	axes.loglog()

	cset = axes.contour(background_xcoords, background_ycoords, numpy.log(background_data), ncontours, cmap = cm.Greys)
	cset = axes.contour(injections_xcoords, injections_ycoords, numpy.log(injections_data), ncontours, cmap = cm.Reds)
	#cbar = fig.add_axes((.75,.15,.1,.75))
	#colorbar.Colorbar(cbar, cset)
	axes.set_title(key)
	axes.set_ylabel(r"$\chi^{2} / \mathrm{DOF}$")
	axes.set_xlabel(r"$\rho^{2}$")
	return fig


def dA_plot(key, background_coords, background_data, injections_coords, injections_data):
	fig = figure.Figure(figsize=(4, 4 / golden_ratio))
	FigureCanvas(fig)
	axes = fig.add_axes((.12, .15, .98 - .12, .90 - .15))

	if numpy.any(background_data):
		axes.semilogy(background_coords, background_data, "k-")
	if numpy.any(injections_data):
		axes.semilogy(injections_coords, injections_data, "r-")

	instrument1, instrument2 = key.split("-")[:2]
	axes.set_title(key)
	axes.set_ylabel("Probability Density")
	axes.set_xlabel(r"$\log_{10} \left|A_{\mathrm{%s}} / A_{\mathrm{%s}}\right|$" % (instrument1, instrument2))
	return fig


def dt_plot(key, background_coords, background_data, injections_coords, injections_data):
	fig = figure.Figure(figsize=(4, 4 / golden_ratio))
	FigureCanvas(fig)
	axes = fig.add_axes((.12, .15, .98 - .12, .90 - .15))

	if numpy.any(background_data):
		axes.semilogy(background_coords, background_data, "k-")
	if numpy.any(injections_data):
		axes.semilogy(injections_coords, injections_data, "r-")

	instrument1, instrument2 = key.split("-")[:2]
	axes.set_title(key)
	axes.set_ylabel("Probability Density")
	axes.set_xlabel(r"$t_{\mathrm{%s}} - t_{\mathrm{%s}}$ (s)" % (instrument1, instrument2))
	return fig


#
# =============================================================================
#
#                                     Main
#
# =============================================================================
#


options, filenames = parse_command_line()


coincparamsdistributions = None
for n, filename in enumerate(filenames):
	if options.verbose:
		print >>sys.stderr, "%d/%d:" % (n + 1, len(filenames)),
	xmldoc = utils.load_filename(filename, gz = (filename or "stdin").endswith(".gz"), verbose = options.verbose)
	if coincparamsdistributions is None:
		coincparamsdistributions = get_coincparamsdistributions(xmldoc)
	else:
		coincparamsdistributions += get_coincparamsdistributions(xmldoc)

for (background_name, background_binnedarray), (injections_name, injections_binnedarray), (zero_lag_name, zero_lag_binnedarray) in zip(sorted(coincparamsdistributions.background_rates.items()), sorted(coincparamsdistributions.injection_rates.items()), sorted(coincparamsdistributions.zero_lag_rates.items())):
	assert injections_name == background_name
	assert zero_lag_name == background_name
	name = background_name
	if name.endswith("_snr2_chi2"):
		outname = "%s.png" % name
		if options.verbose:
			print >>sys.stderr, "generating %s ..." % outname
		background_xcoords, background_ycoords, background_data = clip_binned_array_2d(background_binnedarray, [10, 1e4], [.01, 1e4])
		injections_xcoords, injections_ycoords, injections_data = clip_binned_array_2d(injections_binnedarray, [10, 1e4], [.01, 1e4])
		zero_lag_xcoords, zero_lag_ycoords, injections_data = clip_binned_array_2d(zero_lag_binnedarray, [10, 1e4], [.01, 1e4])
		fig = snr2_chi2_plot("%s" % name.replace("_", "-"), background_xcoords, background_ycoords, numpy.transpose(background_data), injections_xcoords, injections_ycoords, numpy.transpose(injections_data), ncontours = 49)
		if options.verbose:
			print >>sys.stderr, "writing %s ..." % outname
		fig.savefig(outname)
	elif name.endswith("_dt"):
		outname = "%s.png" % name
		if options.verbose:
			print >>sys.stderr, "generating %s ..." % outname
		background_coords, background_data = clip_binned_array_1d(background_binnedarray, (-.03, +.03))
		injections_coords, injections_data = clip_binned_array_1d(injections_binnedarray, (-.03, +.03))
		fig = dt_plot("%s" % name.replace("_", "-"), background_coords, background_data, injections_coords, injections_data)
		if options.verbose:
			print >>sys.stderr, "writing %s ..." % outname
		fig.savefig(outname)
	elif name.endswith("_dA"):
		outname = "%s.png" % name
		if options.verbose:
			print >>sys.stderr, "generating %s ..." % outname
		background_coords, background_data = clip_binned_array_1d(background_binnedarray, (-2, +2))
		injections_coords, injections_data = clip_binned_array_1d(injections_binnedarray, (-2, +2))
		fig = dA_plot("%s" % name.replace("_", "-"), background_coords, background_data, injections_coords, injections_data)
		if options.verbose:
			print >>sys.stderr, "writing %s ..." % outname
		fig.savefig(outname)
