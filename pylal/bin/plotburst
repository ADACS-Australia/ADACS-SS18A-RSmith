#!/usr/bin/python
#
# $Id$
#
# Copyright (C) 2006  Kipp C. Cannon
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

#
# =============================================================================
#
#                                   Preamble
#
# =============================================================================
#

import math
from optparse import OptionParser
import numpy
import sys

from glue import segments
from glue.ligolw import table
from glue.ligolw import lsctables
from glue.ligolw import utils
from pylal import date
from pylal import llwapp
from pylal import rate
from pylal import SnglBurstUtils
from pylal import viz

__author__ = "Kipp Cannon <kipp@gravity.phys.uwm.edu>"
__version__ = "$Revision$"[11:-2]
__date__ = "$Date$"[7:-2]


#
# =============================================================================
#
#                                 Command Line
#
# =============================================================================
#

def parse_command_line():
	parser = OptionParser(version="%prog CVS $Id$")
	parser.add_option("-b", "--base", metavar = "base", default = "plotburst_", help = "set the prefix for output filenames (default = plotburst_)")
	parser.add_option("-f", "--format", metavar = "format", default = "png", help = "set the output image format (default = png)")
	parser.add_option("--plot", metavar = "number", action = "append", default = None, help = "only generate the given plot number")
	parser.add_option("-v", "--verbose", action = "store_true", help = "be verbose")
	options, filenames = parser.parse_args()

	if options.plot:
		options.plot = map(int, options.plot)
	else:
		options.plot = [0, 1, 2, 3, 4, 5, 6, 7]

	return options, (filenames or [None])

try:
	options, filenames = parse_command_line()
except ValueError, e:
	print >>sys.stderr, "error: %s" % str(e)
	sys.exit(1)


#
# =============================================================================
#
#                                    Input
#
# =============================================================================
#

def snglburst_init(self, attrs):
	table.Table.__init__(self, attrs)
	self.nevents = {}
	self.start_time = {}
	self.duration = {}
	self.peak_time = {}
	self.central_freq = {}
	self.bandwidth = {}
	self.lo_freq = {}
	self.snr = {}
	self.confidence = {}

def snglburst_append(self, row):
	if row.ifo not in self.nevents:
		self.nevents[row.ifo] = 0
		self.start_time[row.ifo] = []
		self.duration[row.ifo] = []
		self.peak_time[row.ifo] = []
		self.central_freq[row.ifo] = []
		self.bandwidth[row.ifo] = []
		self.lo_freq[row.ifo] = []
		self.snr[row.ifo] = []
		self.confidence[row.ifo] = []
	self.nevents[row.ifo] += 1
	self.start_time[row.ifo].append(date.LIGOTimeGPS(row.start_time, row.start_time_ns))
	self.duration[row.ifo].append(row.duration)
	self.peak_time[row.ifo].append(date.LIGOTimeGPS(row.peak_time, row.peak_time_ns))
	self.central_freq[row.ifo].append(row.central_freq)
	self.bandwidth[row.ifo].append(row.bandwidth)
	self.lo_freq[row.ifo].append(row.central_freq - row.bandwidth / 2.0)
	self.snr[row.ifo].append(row.snr)
	self.confidence[row.ifo].append(abs(row.confidence))

lsctables.SnglBurstTable.loadcolumns = ["ifo", "start_time", "start_time_ns", "duration", "central_freq", "bandwidth", "snr", "confidence", "peak_time", "peak_time_ns"]
lsctables.SnglBurstTable.__init__ = snglburst_init
lsctables.SnglBurstTable.append = snglburst_append


#
# =============================================================================
#
#                            Document Comprehension
#
# =============================================================================
#

class DocContents(object):
	"""
	A wrapper interface to the XML document.
	"""
	def __init__(self, xmldoc, live_time_program):
		#
		# Extract segmentlist
		#

		self.seglists = llwapp.segmentlistdict_fromsearchsummary(xmldoc, live_time_program)
		self.ifos = self.seglists.keys()

		#
		# Extract columns
		#

		bursttable = table.get_table(xmldoc, lsctables.SnglBurstTable.tableName)
		self.nevents = bursttable.nevents
		self.start_time = bursttable.start_time
		self.duration = bursttable.duration
		self.peak_time = bursttable.peak_time
		self.central_freq = bursttable.central_freq
		self.bandwidth = bursttable.bandwidth
		self.lo_freq = bursttable.lo_freq
		self.snr = bursttable.snr
		self.confidence = bursttable.confidence


#
# =============================================================================
#
#                             Confidence vs. Time
#
# =============================================================================
#

class ConfidenceVsTime(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "GPS Time (s)", "Confidence")
		self.ifo = ifo
		self.x = []
		self.y = []
		self.seglist = segments.segmentlist()
		self.axes.semilogy()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(map(float, contents.peak_time[self.ifo]))
		self.y.extend(contents.confidence[self.ifo])
		self.seglist |= contents.seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Trigger Confidence vs. Time\n(%d Triggers)" % self.nevents)
		self.axes.plot(self.x, self.y, "k+")
		for seg in ~self.seglist & segments.segmentlist([segments.segment(self.axes.get_xlim())]):
			self.axes.axvspan(float(seg[0]), float(seg[1]), facecolor = "k", alpha = 0.2)


#
# =============================================================================
#
#                       Confidence vs. Central Frequency
#
# =============================================================================
#

class ConfidenceVsFrequencyScatter(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Central Frequency (Hz)", "Confidence")
		self.ifo = ifo
		self.x = []
		self.y = []
		self.axes.semilogy()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.central_freq[self.ifo])
		self.y.extend(contents.confidence[self.ifo])

	def finish(self):
		self.axes.set_title("Trigger Confidence vs. Central Frequency\n(%d Triggers)" % self.nevents)
		self.axes.plot(self.x, self.y, "k+")
		self.axes.set_xlim([min(self.x), max(self.x)])


#
# =============================================================================
#
#                          Rate vs. Central Frequency
#
# =============================================================================
#

class RateVsCentralFreq(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo, interval, width):
		SnglBurstUtils.BurstPlot.__init__(self, "Central Frequency (Hz)", "Trigger Rate Spectral Density (triggers / s / Hz)")
		self.ifo = ifo
		self.rate = rate.Rate(interval, width)

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		for f in contents.central_freq[self.ifo]:
			self.rate[f] = 1.0

	def finish(self):
		self.axes.set_title("Trigger Rate vs. Central Frequency\n(%d Triggers)" % self.nevents)
		xvals = self.rate.xvals()
		self.axes.plot(xvals, self.rate.filtered(), "k")
		self.axes.semilogy()
		self.axes.set_xlim([min(xvals), max(xvals)])


#
# =============================================================================
#
#                          Trigger Duration Histogram
#
# =============================================================================
#

class Durations(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Duration (s)", "Trigger Count")
		self.ifo = ifo
		self.bins = {}

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		for dt in contents.duration[self.ifo]:
			if dt in self.bins:
				self.bins[dt] += 1
			else:
				self.bins[dt] = 1

	def finish(self):
		self.axes.set_title("Trigger Durations\n(%d Triggers)" % self.nevents)
		data = zip(self.bins.keys(), self.bins.values())
		data.sort()
		self.axes.plot([d[0] for d in data], [d[1] for d in data], "ko-")


#
# =============================================================================
#
#                       Time Between Triggers Histogram
#
# =============================================================================
#

class Delays(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo, width, max):
		SnglBurstUtils.BurstPlot.__init__(self, "Delay (s)", "Count / Delay")
		self.ifo = ifo
		self.data = {}
		self.width = width
		self.max = max
		self.axes.semilogy()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		peaks = contents.peak_time[self.ifo]
		peaks.sort()
		for i in xrange(1, len(peaks)):
			dt = float(peaks[i] - peaks[i - 1])
			if dt > max:
				continue
			if dt in self.data:
				self.data[dt] += 1
			else:
				self.data[dt] = 1

	def finish(self):
		self.axes.set_title("Time Between Triggers\n(%d Triggers)" % self.nevents)
		data = zip(self.data.iterkeys(), self.data.itervalues())
		data.sort()
		self.axes.plot([d[0] for d in data], [d[1] for d in data], "ko-")

		max_delay = max(self.data.iterkeys())
		bins = rate.Rate(segments.segment(0, max_delay + 2), self.width)
		for key, value in self.data.iteritems():
			bins[key] = value
		yvals = bins.filtered()
		self.axes.plot(bins.xvals(), yvals, "k")

		self.axes.set_xlim([0, self.max])
		self.axes.set_ylim([1, 10.0**(int(math.log10(max(yvals))) + 1)])


#
# =============================================================================
#
#                                 Rate vs. SNR
#
# =============================================================================
#

class RateVsSNR(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "SNR", "Trigger Rate (Hz)")
		self.ifo = ifo
		self.x = []
		self.seglist = segments.segmentlist()
		self.axes.loglog()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.snr[self.ifo])
		self.seglist |= contents.seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Cummulative Trigger Rate vs. SNR\n(%d Triggers)" % self.nevents)
		self.x.sort()
		self.y = numpy.arange(len(self.x), 0.0, -1.0) / float(abs(self.seglist))
		self.axes.plot(self.x, self.y, "ko-")


#
# =============================================================================
#
#                             Rate vs. Confidence
#
# =============================================================================
#

class RateVsConfidence(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Confidence", "Trigger Rate (Hz)")
		self.ifo = ifo
		self.x = []
		self.seglist = segments.segmentlist()
		self.axes.loglog()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.confidence[self.ifo])
		self.seglist |= contents.seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Cummulative Trigger Rate vs. Confidence\n(%d Triggers)" % self.nevents)
		self.x.sort()
		self.y = numpy.arange(len(self.x), 0.0, -1.0, "Float64") / float(abs(self.seglist))
		self.axes.plot(self.x, self.y, "ko-")


#
# =============================================================================
#
#                             Time-Frequency Plane
#
# =============================================================================
#

class TimeFrequencyPlane(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "GPS Time (s)", "Frequency (Hz)")
		self.ifo = ifo
		self.seglist = segments.segmentlist()

	def add_contents(self, contents):
		self.nevents += contents.nevents[self.ifo]
		viz.tfplot(numpy.array(map(float, contents.start_time[self.ifo])), numpy.array(contents.duration[self.ifo]), numpy.array(contents.lo_freq[self.ifo]), numpy.array(contents.bandwidth[self.ifo]), numpy.log(numpy.array(contents.confidence[self.ifo])), axes = self.axes)
		self.seglist |= contents.seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Time-Frequency Plane\n(%d Triggers)" % self.nevents)
		for seg in ~self.seglist & segments.segmentlist([segments.segment(self.axes.get_xlim())]):
			self.axes.axvspan(float(seg[0]), float(seg[1]), facecolor = "k", alpha = 0.2)


#
# =============================================================================
#
#                                     Plot
#
# =============================================================================
#

def new_plots(ifo, plots):
	l = [
		RateVsCentralFreq(ifo, segments.segment(70, 2118), 5),
		Durations(ifo),
		Delays(ifo, 0.125, 200),
		RateVsSNR(ifo),
		RateVsConfidence(ifo),
		ConfidenceVsTime(ifo),
		ConfidenceVsFrequencyScatter(ifo),
		TimeFrequencyPlane(ifo)
	]
	return [l[i] for i in plots]

plots = {}
for n, filename in enumerate(utils.sort_files_by_size(filenames, options.verbose, reverse = True)):
	if options.verbose:
		print >>sys.stderr, "%d/%d:" % (n + 1, len(filenames)),
	doc = utils.load_filename(filename, options.verbose, gz = filename[-3:] == ".gz")
	contents = DocContents(doc, "power")
	for ifo in contents.ifos:
		if ifo not in plots:
			plots[ifo] = new_plots(ifo, options.plot)
		if ifo not in contents.nevents:
			continue
		for plotnum, plot in zip(options.plot, plots[ifo]):
			if options.verbose:
				print >>sys.stderr, "adding to %s plot %d..." % (ifo, plotnum)
			plot.add_contents(contents)
	doc.unlink()


#
# =============================================================================
#
#                                    Output
#
# =============================================================================
#

# delete the plots as we go to save memory
for ifo in plots:
	n = 0
	format = "%%s%s_%%0%dd.%%s" % (ifo, int(math.log10(max(options.plot) or 1)) + 1)
	while len(plots[ifo]):
		filename = format % (options.base, options.plot[n], options.format)
		if options.verbose:
			print >>sys.stderr, "finishing %s plot %d..." % (ifo, options.plot[n])
		plots[ifo][0].finish()
		if options.verbose:
			print >>sys.stderr, "writing %s..." % filename
		plots[ifo][0].fig.savefig(filename)
		del plots[ifo][0]
		n += 1
