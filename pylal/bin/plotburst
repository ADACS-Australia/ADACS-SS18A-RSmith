#!/usr/bin/python
#
# $Id$
#
# Copyright (C) 2006  Kipp C. Cannon
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.


#
# =============================================================================
#
#                                   Preamble
#
# =============================================================================
#


import math
from optparse import OptionParser
import numpy
import sys


from glue import segments
from glue.lal import CacheEntry
from glue.ligolw import table
from glue.ligolw import lsctables
from glue.ligolw import utils
from pylal import date
from pylal import llwapp
from pylal import rate
from pylal import SnglBurstUtils
from pylal import viz


__author__ = "Kipp Cannon <kipp@gravity.phys.uwm.edu>"
__version__ = "$Revision$"[11:-2]
__date__ = "$Date$"[7:-2]


#
# =============================================================================
#
#                                 Command Line
#
# =============================================================================
#


def parse_command_line():
	parser = OptionParser(version="%prog CVS $Id$")
	parser.add_option("-b", "--base", metavar = "base", default = "plotburst_", help = "set the prefix for output filenames (default = plotburst_)")
	parser.add_option("-f", "--format", metavar = "format", default = "png", help = "set the output image format (default = png)")
	parser.add_option("-i", "--input-cache", metavar = "filename", default = None, help = "get file names from this LAL cache file")
	parser.add_option("--plot", metavar = "number", action = "append", default = None, help = "only generate the given plot number")
	parser.add_option("-v", "--verbose", action = "store_true", help = "be verbose")
	options, filenames = parser.parse_args()

	if options.input_cache:
		filenames.extend([c.path() for c in map(CacheEntry, file(options.input_cache))])

	if options.plot:
		options.plot = map(int, options.plot)
	else:
		options.plot = range(8)

	return options, (filenames or [None])


options, filenames = parse_command_line()


#
# =============================================================================
#
#                                    Input
#
# =============================================================================
#


class Summary(object):
	def __init__(self):
		self.nevents = {}
		self.start_time = {}
		self.duration = {}
		self.peak_time = {}
		self.peak_freq = {}
		self.bandwidth = {}
		self.lo_freq = {}
		self.snr = {}
		self.confidence = {}


def snglburst_append(self, row):
	global summary
	if row.ifo not in summary.nevents:
		summary.nevents[row.ifo] = 0
		summary.start_time[row.ifo] = []
		summary.duration[row.ifo] = []
		summary.peak_time[row.ifo] = []
		summary.peak_freq[row.ifo] = []
		summary.bandwidth[row.ifo] = []
		summary.lo_freq[row.ifo] = []
		summary.snr[row.ifo] = []
		summary.confidence[row.ifo] = []
	summary.nevents[row.ifo] += 1
	summary.start_time[row.ifo].append(date.LIGOTimeGPS(row.start_time, row.start_time_ns))
	summary.duration[row.ifo].append(row.duration)
	summary.peak_time[row.ifo].append(date.LIGOTimeGPS(row.peak_time, row.peak_time_ns))
	summary.peak_freq[row.ifo].append(row.peak_frequency)
	summary.bandwidth[row.ifo].append(row.bandwidth)
	summary.lo_freq[row.ifo].append(row.central_freq - row.bandwidth / 2.0)
	summary.snr[row.ifo].append(row.snr)
	summary.confidence[row.ifo].append(row.confidence)


lsctables.SnglBurstTable.append = snglburst_append


#
# =============================================================================
#
#                             Confidence vs. Time
#
# =============================================================================
#


class ConfidenceVsTime(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "GPS Time (s)", "Confidence")
		self.ifo = ifo
		self.x = []
		self.y = []
		self.seglist = segments.segmentlist()
		self.axes.semilogy()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(map(float, contents.peak_time[self.ifo]))
		self.y.extend(contents.confidence[self.ifo])
		self.seglist |= seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Trigger Confidence vs. Time\n(%d Triggers)" % self.nevents)
		self.axes.plot(self.x, self.y, "k+")
		for seg in ~self.seglist & segments.segmentlist([segments.segment(self.axes.get_xlim())]):
			self.axes.axvspan(float(seg[0]), float(seg[1]), facecolor = "k", alpha = 0.2)


#
# =============================================================================
#
#                        Confidence vs. Peak Frequency
#
# =============================================================================
#


class ConfidenceVsFrequencyScatter(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Peak Frequency (Hz)", "Confidence")
		self.ifo = ifo
		self.x = []
		self.y = []
		self.axes.semilogy()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.peak_freq[self.ifo])
		self.y.extend(contents.confidence[self.ifo])

	def finish(self):
		self.axes.set_title("Trigger Confidence vs. Peak Frequency\n(%d Triggers)" % self.nevents)
		self.axes.plot(self.x, self.y, "k+")
		self.axes.set_xlim((min(self.x), max(self.x)))


#
# =============================================================================
#
#                           Rate vs. Peak Frequency
#
# =============================================================================
#


class RateVsPeakFreq(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo, interval, width):
		SnglBurstUtils.BurstPlot.__init__(self, "Peak Frequency (Hz)", "Trigger Rate Spectral Density (triggers / s / Hz)")
		self.ifo = ifo
		self.rate = rate.Rate(interval, width)

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		for f in contents.peak_freq[self.ifo]:
			self.rate[f] += 1.0

	def finish(self):
		self.axes.set_title("Trigger Rate vs. Peak Frequency\n(%d Triggers)" % self.nevents)
		xvals = self.rate.xvals()
		self.axes.plot(xvals, self.rate.filter(), "k")
		self.axes.semilogy()
		self.axes.set_xlim((min(xvals), max(xvals)))


#
# =============================================================================
#
#                          Trigger Duration Histogram
#
# =============================================================================
#


class Durations(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Duration (s)", "Trigger Count")
		self.ifo = ifo
		self.bins = {}

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		for dt in contents.duration[self.ifo]:
			if dt not in self.bins:
				self.bins[dt] = 0
			self.bins[dt] += 1

	def finish(self):
		self.axes.set_title("Trigger Durations\n(%d Triggers)" % self.nevents)
		data = self.bins.items()
		data.sort()
		self.axes.plot([d[0] for d in data], [d[1] for d in data], "ko-")


#
# =============================================================================
#
#                       Time Between Triggers Histogram
#
# =============================================================================
#


class Delays(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo, width, max):
		SnglBurstUtils.BurstPlot.__init__(self, "Delay (s)", "Count / Delay")
		self.ifo = ifo
		self.bins = rate.Rate(segments.segment(0, max + 2), width)
		self.axes.semilogy()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		peaks = list(contents.peak_time[self.ifo])
		peaks.sort()
		for i in xrange(1, len(peaks)):
			dt = float(peaks[i] - peaks[i - 1])
			try:
				self.bins[dt] += 1
			except IndexError:
				# out of bounds
				pass

	def finish(self):
		self.axes.set_title("Time Between Triggers\n(%d Triggers)" % self.nevents)

		xvals = self.bins.xvals()
		yvals = self.bins.filter()
		self.axes.plot(xvals, yvals, "k")

		self.axes.set_xlim((0, xvals[-1]))
		self.axes.set_ylim((1, 10.0**(int(math.log10(max(yvals))) + 1)))


#
# =============================================================================
#
#                                 Rate vs. SNR
#
# =============================================================================
#


class RateVsSNR(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "SNR", "Trigger Rate (Hz)")
		self.ifo = ifo
		self.x = []
		self.seglist = segments.segmentlist()
		self.axes.loglog()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.snr[self.ifo])
		self.seglist |= seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Cummulative Trigger Rate vs. SNR\n(%d Triggers)" % self.nevents)
		self.x.sort()
		self.y = numpy.arange(len(self.x), 0.0, -1.0) / float(abs(self.seglist))
		self.axes.plot(self.x, self.y, "ko-")


#
# =============================================================================
#
#                             Rate vs. Confidence
#
# =============================================================================
#


class RateVsConfidence(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "Confidence", "Trigger Rate (Hz)")
		self.ifo = ifo
		self.x = []
		self.seglist = segments.segmentlist()
		self.axes.loglog()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		self.x.extend(contents.confidence[self.ifo])
		self.seglist |= seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Cummulative Trigger Rate vs. Confidence\n(%d Triggers)" % self.nevents)
		self.x.sort()
		self.y = numpy.arange(len(self.x), 0.0, -1.0, "Float64") / float(abs(self.seglist))
		self.axes.plot(self.x, self.y, "ko-")


#
# =============================================================================
#
#                             Time-Frequency Plane
#
# =============================================================================
#


class TimeFrequencyPlane(SnglBurstUtils.BurstPlot):
	def __init__(self, ifo):
		SnglBurstUtils.BurstPlot.__init__(self, "GPS Time (s)", "Frequency (Hz)")
		self.ifo = ifo
		self.seglist = segments.segmentlist()

	def add_contents(self, contents, seglists):
		self.nevents += contents.nevents[self.ifo]
		viz.tfplot(numpy.array(map(float, contents.start_time[self.ifo])), numpy.array(contents.duration[self.ifo]), numpy.array(contents.lo_freq[self.ifo]), numpy.array(contents.bandwidth[self.ifo]), numpy.log(numpy.array(contents.confidence[self.ifo])), axes = self.axes)
		self.seglist |= seglists[self.ifo]

	def finish(self):
		self.axes.set_title("Time-Frequency Plane\n(%d Triggers)" % self.nevents)
		for seg in ~self.seglist & segments.segmentlist([segments.segment(self.axes.get_xlim())]):
			self.axes.axvspan(float(seg[0]), float(seg[1]), facecolor = "k", alpha = 0.2)


#
# =============================================================================
#
#                                  Load Data
#
# =============================================================================
#


summary = Summary()
seglists = segments.segmentlistdict()


for n, filename in enumerate(utils.sort_files_by_size(filenames, options.verbose, reverse = True)):
	if options.verbose:
		print >>sys.stderr, "%d/%d:" % (n + 1, len(filenames)),
	xmldoc = utils.load_filename(filename, options.verbose, gz = filename.endswith(".gz"))
	seglists |= llwapp.segmentlistdict_fromsearchsummary(xmldoc, "lalapps_power")
	xmldoc.unlink()


#
# =============================================================================
#
#                                     Plot
#
# =============================================================================
#


def new_plots(ifo, plots):
	l = (
		RateVsPeakFreq(ifo, segments.segment(70, 2118), 4),
		Durations(ifo),
		Delays(ifo, 0.25, 20),
		RateVsSNR(ifo),
		RateVsConfidence(ifo),
		ConfidenceVsTime(ifo),
		ConfidenceVsFrequencyScatter(ifo),
		TimeFrequencyPlane(ifo)
	)
	return [l[i] for i in plots]


for ifo in summary.nevents.keys():
	format = "%%s%s_%%0%dd.%%s" % (ifo, int(math.log10(max(options.plot) or 1)) + 1)
	for plotnum, plot in zip(options.plot, new_plots(ifo, options.plot)):
		filename = format % (options.base, plotnum, options.format)
		if options.verbose:
			print >>sys.stderr, "adding to %s plot %d ..." % (ifo, plotnum)
		plot.add_contents(summary, seglists)
		if options.verbose:
			print >>sys.stderr, "finishing %s plot %d ..." % (ifo, plotnum)
		plot.finish()
		if options.verbose:
			print >>sys.stderr, "writing %s ..." % filename
		plot.fig.savefig(filename)
