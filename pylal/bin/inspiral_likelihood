#!/usr/bin/python

import sys
import exceptions 
from optparse import *
import glob

from glue.ligolw import table
from glue.ligolw import lsctables
from glue.ligolw import utils
from pylal import CoincInspiralUtils
from pylal import SnglInspiralUtils
from pylal import SimInspiralUtils
from pylal.tools import XLALCalculateEThincaParameter

from pylab import*
import pylal.itertools
import numpy
################################################################################
usage= """
usage: %prog [options]

Calculate likelihood ratio and assign ranking based on it to each 
candidate trigger.
"""
###############################################################################
# Options to read in Input
###############################################################################
parser = OptionParser( usage=usage, version="%prog CVS $Id$ " )
parser.add_option("-z","--zerolag-glob",action="store",type="string",\
    default=None, metavar=" GLOB",help="GLOB zero lag  thinca files to read" )
parser.add_option("-s","--slides-glob",action="store",type="string",\
    default=None, metavar=" GLOB",help="GLOB time slides thinca files to read" )
parser.add_option("-i","--inj-glob",action="store",type="string",\
    default=None, metavar=" GLOB",help="GLOB thinca files with injections to read" )


# Options to select ifo types.

parser.add_option("-B", "--h1-triggers",action="store_true", default=False,\
    help="input files contain triggers from H1")

parser.add_option("-C", "--h2-triggers",action="store_true", default=False,\
    help="input files contain triggers from H2")

parser.add_option("-D", "--l1-triggers",action="store_true", default=False,\
    help="input files contain triggers from L1")

parser.add_option("-E", "--g1-triggers",action="store_true", default=False,\
    help="input files contain triggers from G1")


# Options to select paramters for calculation of p(c|0), p(c|h) and likelihood ratio. 

parser.add_option("-S","--statistic",action="store",default='snr',\
    type="string",\
    help="choice of statistic used in making plots, valid arguments are: "             "snr (DEFAULT), snr_over_chi, s3_snr_chi_stat, effective_snr, " 
    "bitten_l, bitten_lsq")

parser.add_option("-e","--epsilon",action="store",type="float",\
    default=0.3, metavar=" EPSILON", help="radius of the hypersphere in the parameter space that defines closeness of events" )

parser.add_option("-N","--numslides", action="store",type="int",\
    default = 0, metavar="NUMSLIDES", help="number of time slides performed, must match the corresponding parameter from the .ini file" )

parser.add_option("-k","--kappa", action="store",type="float",\
    default = 0, metavar="KAPPA", help="The value of kappa to be supplied to perform distance cut" )

# Plotting options

parser.add_option("-P","--plot-simethinca",action="store_true",\
    default=False, help ="Shows the plot of simple ethinca param for different coincs")


parser.add_option("-p","--plot-distcut",action="store_true",\
    default=False, help ="Shows the plot of effective distance difference based on distance cut")


parser.add_option("-M","--plot-mchirp",action="store_true",\
    default=False, help ="Shows the plot of chirp mass difference based on distance cut")



parser.add_option("-L","--likelihood",action="store_true",\
    default=False, help ="Calculates the Likelihood for different IFOs and writes them in a file.")


parser.add_option("-V","--verbose",action="store_true",default=False,\
    help="print additional information when running" )

parser.add_option("-F","--figure-name",action="store", type = "string",\
    default = None, metavar = "NAME", help="saves figure with NAME.png" )

parser.add_option("-o","--show",action="store_true",default=False,\
    help="Display the plots on the screen" )

parser.add_option("-b","--slide-bins",action="store",type="int",\
    default=10, metavar="BINS", help="Number of bins in the histogram of background")

parser.add_option("-j","--injection-bins",action="store",type="int",\
    default=10, metavar="BINS", help="Number of bins in the histogram of injections")


(opts,args) = parser.parse_args()

######################################################################
# Construct IFO pairs


ifo_list = [ifo for ifo in ("G1", "H1", "H2", "L1") \
            if getattr(opts, "%s_triggers" % ifo.lower())]

ifo_combos = CoincInspiralUtils.get_ifo_combos(ifo_list)

########################################################################
# Class to hold slides and triggers and generate relevant plots.
########################################################################
def distcut(coinc_a,coinc_b):
    
  dist_cut_array = []
  dist_cut_array.append((coinc_a -  coinc_b)*2.0/(coinc_a +  coinc_b))
  return dist_cut_array

def normalized_hist(Unormalised_array, bins=None):
  if bins:
    (y_param, x_param, patches) = hist(Unormalised_array, bins)
  else:
    (y_param, x_param, patches) = hist(Unormalised_array)
  clf()
  y_norm = y_param*1.0/sum(y_param)
  return (y_norm, x_param)


class plotdata:

  """ Class to do plotting of time slides and injections for
    range of parameters. """


  def plotroutine(self, ifos, coinc_a, coinc_b, param, slide_bins, inj_bins):
    for ifo in ifos:
      if len(ifo) > 2: 
        pass
      else:     
        if param == 'simethinca':
          coinc_a_sim = coinc_a.coinctype(ifo).getSimpleEThincaValues(ifo)
          coinc_b_sim = coinc_b.coinctype(ifo).getSimpleEThincaValues(ifo)
        else:
          coinc_a_fir = coinc_a.coinctype(ifo).getsngls(ifo[0]).get_column(param)
          coinc_a_sec = coinc_a.coinctype(ifo).getsngls(ifo[1]).get_column(param)
          coinc_b_fir = coinc_b.coinctype(ifo).getsngls(ifo[0]).get_column(param)
          coinc_b_sec = coinc_b.coinctype(ifo).getsngls(ifo[1]).get_column(param)
 
         
        if param == 'simethinca':
          (y_slide, x_slide) = normalized_hist(coinc_a_sim, slide_bins)
          (y_inj, x_inj) = normalized_hist(coinc_b_sim, inj_bins)
        else: 
          dist_cut_a = distcut(coinc_a_fir,coinc_a_sec)
          dist_cut_b = distcut(coinc_b_fir,coinc_b_sec)

          if len(dist_cut_a):
            (y_slide, x_slide) = normalized_hist(dist_cut_a, slide_bins)
         
          if len(dist_cut_b):
            (y_inj, x_inj) = normalized_hist(dist_cut_b, inj_bins)


        slide_val = bar(x_slide,y_slide,width=(x_slide[1]-x_slide[0]),color="k")
        hold(True)
        inj_val =  bar(x_inj,y_inj,width=(x_inj[1]-x_inj[0]),color="r")
        legend([inj_val[0],slide_val[0]],["Injections","Background"],loc=0)
        xlabel(str(param) + '_' + 'difference' + '_' + str(ifo[0]) + '_' + str(ifo[1]))
        savefig(str(param) + "_" + str(ifo[0]) + "_" +  str(ifo[1]) )
        figure()
        


####################################################################
#glob the list of files to read in

# Zero lag  Files
if opts.zerolag_glob:  
  zerolagfiles = []      
  zerolagfiles = glob.glob(opts.zerolag_glob)  
  if len(zerolagfiles) < 1:    
    print >>sys.stderr, "The glob for " + opts.zerolag_glob + " returned no files"
    sys.exit(1)  

# Time slides Files
if opts.slides_glob:      
  slidesfiles = []  
  slidesfiles = glob.glob(opts.slides_glob)  
  if len(slidesfiles) < 1:    
    print >>sys.stderr, "The glob for " + opts.slides_glob + " returned no files" 
    sys.exit(1)    
   
 
# Injection Files
if opts.inj_glob:
  injfiles = []
  injfiles = glob.glob(opts.inj_glob)
  if len(injfiles) < 1:
    print >>sys.stderr, "The glob for " + opts.inj_glob + "returned no files " 
    sys.exit(1)

# check that statistic is OK:
if opts.statistic not in ('snr', 'snr_over_chi', 's3_snr_chi_stat', 'effective_snr', 'bitten_lsq', 'bitten_l'):
  print >>sys.stderr, "--statistic must be one of"  
  print >>sys.stderr, "(snr|snr_over_chi|s3_snr_chi_stat|effective_snr|bitten_l)"
  sys.exit(1)

# check if number of slides is given
if opts.numslides == 0:
  print >> sys.stderr, "--numslides must be specified"
  sys.exit(1)


statistic = CoincInspiralUtils.coincStatistic( opts.statistic) 


###############################################################################
# read in zero lag coinc triggers

zerolagTriggers = None

zerolagTriggers = SnglInspiralUtils.ReadSnglInspiralFromFiles(zerolagfiles,mangle_event_id=False)

# construct the zero lag coincs 
zerolagCoincTriggers= \
CoincInspiralUtils.coincInspiralTable(zerolagTriggers, statistic)

# construct zero lag coincs of type:

#zerolagCoincType = CoincInspiralUtils.coincInspiralTable(zerolagTriggers, statistic).coinctype(["H1","L1"])
#print zerolagCoincType


# read in time slides triggers 

slidesTriggers = None

slidesTriggers = SnglInspiralUtils.ReadSnglInspiralFromFiles(slidesfiles,mangle_event_id=True)

# construct the time slides coincs
slidesCoincTriggers= \
CoincInspiralUtils.coincInspiralTable(slidesTriggers, statistic)

# read in injections sngl and sim inspirals

injectionTriggers = None

injectionTriggers = SnglInspiralUtils.ReadSnglInspiralFromFiles(injfiles,mangle_event_id=True)

simTriggers = None

simTriggers = SimInspiralUtils.ReadSimInspiralFromFiles(injfiles)   


#construct injection coincs and add sim inspirals

injectionCoincTriggers= \
CoincInspiralUtils.coincInspiralTable(injectionTriggers, statistic)

injectionCoincTriggers.add_sim_inspirals(simTriggers)





######################################
#Experimental area

#counter=0
#file=open('slidestriggers', 'w')
#for trigger in slidesCoincTriggers:
#  ifo, ifolist = trigger.get_ifos()
#  file.write(str(ifo) + '\n')
#  counter+=1
#print str(counter)
#file.close()

#for candidate in slidesCoincTriggers:
  #  ethinca=XLALCalculateEThincaParameter(candidate.H1, candidate.L1)
  #c_ifo, ifolist = candidate.get_ifos()
  #if c_ifo=='H1L1':
  #  simethinca = CoincInspiralUtils.simpleEThinca(candidate.H1, candidate.L1)
  #  if simethinca > 100.0:
  #    CoincInspiralUtils.simpleEThinca(candidate.H1, candidate.L1)
  #    print simethinca

  #  d_tmp1=1.0 - simethinca**2
  #  d_tmp2=1.0 - simethinca**2/4.0
  #  d_tmp3=simethinca**2/4.0
  #print simethinca




###################################################################################
# calculate the likelihood ratio for each of zerolagCoincTriggers
####################################################################################


if opts.likelihood:

  BackgroundFractionFile=open('BackgroundFraction', 'w')
  LikelihoodFile=open('Likelihood', 'w')
  Nslides=opts.numslides
  for candidate in zerolagCoincTriggers:
    c_ifos,ifolist=candidate.get_ifos()
    # calculating the false alarm probability
    slide_array=numpy.zeros(2*Nslides)
    slides_within_epsilon = slidesCoincTriggers.getTriggersWithinEpsilon(candidate, opts.epsilon)

    for slide in range(1, Nslides+1):
      #slideTrigger_forward = CoincInspiralUtils.coincInspiralTable()
      #slideTriggers_backward = CoincInspiralUtils.coincInspiralTable()
      slideTriggers_forward = slides_within_epsilon.getslide(slide)
      slideTriggers_backward = slides_within_epsilon.getslide(-slide)
      if len(slideTriggers_forward) >= 1:
        slide_array[slide - 1] = 1.0
      if len(slideTriggers_backward) >= 1:
        slide_array[Nslides-1+slide] = 1.0

    FalseAlarmProb = sum(slide_array)/float(2*Nslides)

    # calculating the detection probability for each of zerolagTriggers
    Ntotal_inj=0
    for trigger in injectionCoincTriggers:
      trig_ifos,trig_ifolist = trigger.get_ifos()
      if c_ifos == trig_ifos:
        Ntotal_inj += 1

    injections_within_epsilon = injectionCoincTriggers.getTriggersWithinEpsilon(candidate, opts.epsilon)
  
    nevents_inj = len(injections_within_epsilon)

    if Ntotal_inj > 0:
      DetectionProb = float(nevents_inj) / float(Ntotal_inj)
    else:
      DetectionProb = 0.0

    # Calculating likelihood ratio
    if FalseAlarmProb > 0: 
      Likelihood = DetectionProb / FalseAlarmProb
    else:
      Likelihood = -1.0 

    if opts.verbose:
      print str(Likelihood)

    #calculating BackgroundFraction - the fraction of background triggers within epsilon distance from the given candidate
    #of all background triggers in all of the timeslides
    Ntotal_noise=0
    for trigger in slidesCoincTriggers:
      trig_ifos,trig_ifolist=trigger.get_ifos()
      if c_ifos==trig_ifos:
        Ntotal_noise+=1

    slides_within_epsilon =CoincInspiralUtils.coincInspiralTable()
    slides_within_epsilon=slidesCoincTriggers.getTriggersWithinEpsilon(candidate, opts.epsilon)

    nevents_noise = len(slides_within_epsilon)

    if Ntotal_noise > 0:
       BackgroundFraction = float(nevents_noise)/float(Ntotal_noise)
    else:
       BackgroundFraction = -1.0

    # Calculating the ratio of DetectionProb to BackgroundFraction
    if BackgroundFraction > 0:
      DetectionBackgroundRatio= DetectionProb/BackgroundFraction
    else:
      DetectionBackgroundRatio = -1.0

    if opts.verbose:
      print str(DetectionBackgroundRatio)

    # writing the false alarm probability, the detection probability and the likelihood ration into file
    LikelihoodFile.write('%d\t%s\t%e\t%e\t%e\n' % (candidate.event_id, c_ifos, FalseAlarmProb, DetectionProb, Likelihood))

    # writing the BackgroundFraction, DetectionProb and DetectionBackgroundRatio  into file
    
    BackgroundFractionFile.write('%d\t%s\t%e\t%e\t%e\n' % (candidate.event_id, c_ifos, BackgroundFraction, DetectionProb,\
    DetectionBackgroundRatio))
   


 
  LikelihoodFile.close()
  BackgroundFractionFile.close()
###################################################################################
# Plot the various parameters for time slides and injections
###################################################################################


if opts.plot_simethinca:
  plotdata().plotroutine(ifo_combos,slidesCoincTriggers,injectionCoincTriggers,'simethinca', opts.slide_bins, opts.injection_bins)

if opts.plot_distcut:
  plotdata().plotroutine(ifo_combos,slidesCoincTriggers,injectionCoincTriggers,'eff_distance', opts.slide_bins, opts.injection_bins)

if opts.plot_mchirp:
  plotdata().plotroutine(ifo_combos,slidesCoincTriggers,injectionCoincTriggers,'mchirp', opts.slide_bins, opts.injection_bins)
   
    
if opts.show:
  show()










