#!/usr/bin/python

from __future__ import division

import os,sys
import glob
import matplotlib
matplotlib.use('Agg')
import pylab
from optparse import OptionParser
from pylal import SimInspiralUtils
from pylal import MultiInspiralUtils
from glue.ligolw import ilwd
from glue.ligolw import ligolw
from glue.ligolw import table
from glue.ligolw import lsctables
from glue.ligolw import utils
from pylal import grbsummary
from pylal import date
from pylal import rate
from pylal import antenna
from pylal import plotutils
from pylal import pylal_exttrig_llutils as peu
from pylal.coh_PTF_pyutils import *

html_part_1_template = '''<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="en">
<head>
</head>
<body>
<div style="text-align: center;">
<span style="font-weight: bold;">
</span>
<span style="font-weight: bold;">
Coherent PTF Inspiral search of GRB&nbsp;macrogrbname</span>
<br>
</div>
<div style="text-align: center;">
<span style="font-weight: bold;">
</span>

</div>
<span style="font-weight: bold;">
</span>
<br>
<p>
<b>Basic information</b>
<table style="text-align: left;" border="1" cellpadding="2" cellspacing="2" width="700">
<tbody>
<tr>
<td>GPS</td>
<td>Date</td>
<td>RA</td>
<td>DEC</td>
<td>IFOS</td>
</tr>
<tr>
<td>macrogpstime</a></td>
<td>macrogrbdate</td>
<td>macrorightascension</td>
<td>macrodeclination</td>
<td>macroifostring</td>
</tr>
</tbody>
</table>
</p>
<p>
<b>Antenna factors</b>
<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td>Hanford</td>
<td>Livingston</td>
<td>Virgo</td>
</tr>
<tr>
<td>macrohresponse</td>
<td>macrolresponse</td>
<td>macrovresponse</td>
</tr>
</tbody>
</table>
</p>
<br>
summary of this GRB <a href="http://grblog.org/grblog.php?view=burst&GRB=macrogrbname">here</a><br>
google sky kml-file <a href="macrogrbname.kml">here</a><br>
segments availability <a href="plot_segments_macrogrbname.png">here</a><br>
ini-file used <a href="S6GRB_trigger_hipe.ini">here</a><br>
conf-file used <a href="llmonitor.conf">here</a><br>
'''

html_part_2_template = '''<h2> Offsource triggers vs time </h2>
<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td> Coherent SNR </td>
macroifolist
</tr>
<tr>
<td> <a href="macrooutdir/OFFSOURCE/GRBmacrogrbname_triggers_vs_time_noinj.png" title="Triggers vs time"><img src="macrooutdir/OFFSOURCE/GRBmacrogrbname_triggers_vs_time_noinj.png" border="2" width="300"></a> </td>
macroifoplots
</tr>
</tbody>
</table>
'''

trig_plot_tmplt = '''<td> <a href="macrooutdir/OFFSOURCE/GRBmacrogrbname_macroifo_triggers_vs_time_noinj.png" title="macroifo SNR vs time"><img src="macrooutdir/OFFSOURCE/GRBmacrogrbname_macroifo_triggers_vs_time_noinj.png" border="2" width="300"></a> </td>'''

html_part_3_template = '''<h2> Signal consistency </h2>
<h3> Chi squared tests </h3>
<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td> </td>
macroinjlist
</tr>
<tr>
<td> Bank veto </td>
macrobankveto
</tr>
<tr>
<td> Auto veto </td>
macroautoveto
</tr>
<tr>
<td> Chi squared </td>
macroschisquared
</tr>
</tbody>
</table>

<h3> Individual detector and null SNRs </h3>
<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td> Null SNR </td>
macronull1
</tr>
macrosnrplots
</tbody>
</table>
'''

sbv_plot_tmplt = '''<td><a href="macrooutdir/plots_clustered/GRBmacrogrbname_macroplotname.png" title="GRBmacrogrbname_macroplotname"><img src="macrooutdir/plots_clustered/GRBmacrogrbname_macroplotname.png" border="2" width="300"></a> </td>'''

ifo_snr_sec_tmplt = '''<tr>
<td> macroifo SNR </td>
macrosnrifoplots
</tr>'''

html_part_4_template = '''<h2> Found/missed injections </h2>
<h3> A key for these plots </h3>
<p> Black cross indicates no trigger was found coincident with the injection </p>
<p> Red cross indicates a trigger was found coincident with the injection but it was vetoed </p>
<p> Green cross indicates that a trigger was found coincident with the injection and it was louder than all events in the offsource </p>
<p> Coloured circle indicates that a trigger was found coincident with the injection
 but it was not louder than all offsource events. The colour bar gives the FAP of the trigger. </p>

<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td> </td>
macroinjlist
</tr>
<tr>
<td> Eff dist h vs mchirp</td>
macroinjplotone
</tr>
<tr>
<td> Eff dist h vs time</td>
macroinjplottwo
</tr>
<tr>
<td> Eff dist l vs mchirp</td>
macroinjplotthree
</tr>
<tr>
<td> Eff dist l vs time</td>
macroinjplotfour
</tr>
<tr>
<td> Eff dist v vs mchirp</td>
macroinjplotfive
</tr>
<tr>
<td> Eff dist v vs time</td>
macroinjplotsix
</tr>
<tr>
<td> Close injections without FAP = 0 </td>
macrocmi
</tr>
</tbody>
</table>
'''

inj_plot_one_tmplt = '''<td><a href="macrooutdir/macroinjdir/efficiency/found_missed_injections_effdist_macroifo.png" title="found_missed_injections_effdist_macroifo.png"><img src="macrooutdir/macroinjdir/efficiency/found_missed_injections_effdist_macroifo.png" border="2" width="300"></a> </td>'''

inj_plot_two_tmplt = '''<td><a href="macrooutdir/macroinjdir/efficiency/found_missed_injections_effdist_time_macroifo.png" title="found_missed_injections_effdist_time_macroifo.png"><img src="macrooutdir/macroinjdir/efficiency/found_missed_injections_effdist_time_macroifo.png" border="2" width="300"></a> </td>'''

inj_plot_three_tmplt = '''<td><a href="macrooutdir/macroinjdir/efficiency/found_missed_injections_dist.png" title="found_missed_injections_dist.png"><img src="macrooutdir/macroinjdir/efficiency/found_missed_injections_dist.png" border="2" width="300"></a> </td>'''

inj_plot_four_tmplt = '''<td><a href="macrooutdir/macroinjdir/efficiency/found_missed_injections_dist_time.png" title="found_missed_injections_dist_time.png"><img src="macrooutdir/macroinjdir/efficiency/found_missed_injections_dist_time.png" border="2" width="300"></a> </td>'''

cmi_tmplt = '''<td> <a href="macrooutdir/macroinjdir/efficiency/quiet_found_triggers.txt"> here </a></td>'''

html_part_5_template = '''<h2> Loudest offsource events </h2>

<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">

<tbody>
<tr>
<td> </td>
<td> Mchirp 0 - 3.48 </td>
<td> Mchirp 3.48 - 6.0 </td>
<td> Mchirp 6.0 - 20.0 </td>
</tr>
<tr>
<td> Using BestNR </td>
<td><a href="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_0_3.48.png" title="bestnr_vs_fap_0_3.48.png"><img src="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_0_3.48.png" border="2" width="300"></a> </td>
<td><a href="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_3.48_6.0.png" title="bestnr_vs_fap_3.48_6.0.png"><img src="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_3.48_6.0.png" border="2" width="300"></a> </td>
<td><a href="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_6.0_20.png" title="bestnr_vs_fap_6.0_20.png"><img src="macrooutdir/OFFTRIAL_1/bestnr_vs_fap_6.0_20.png" border="2" width="300"></a> </td>
</tr>
<tr>
<td> Using SNR </td>
<td><a href="macrooutdir/OFFTRIAL_1/snr_vs_fap_0_3.48.png" title="snr_vs_fap_0_3.48.png"><img src="macrooutdir/OFFTRIAL_1/snr_vs_fap_0_3.48.png" border="2" width="300"></a> </td>
<td><a href="macrooutdir/OFFTRIAL_1/snr_vs_fap_3.48_6.0.png" title="snr_vs_fap_3.48_6.0.png"><img src="macrooutdir/OFFTRIAL_1/snr_vs_fap_3.48_6.0.png" border="2" width="300"></a> </td>
<td><a href="macrooutdir/OFFTRIAL_1/snr_vs_fap_6.0_20.png" title="snr_vs_fap_6.0_20.png"><img src="macrooutdir/OFFTRIAL_1/snr_vs_fap_6.0_20.png" border="2" width="300"></a> </td>
</tr>
</tbody>
</table>'''

html_trial_template = '''<h2> Events in macrotrial </h2>
<table style="text-align: left; width: 30%;" border="1" cellpadding="2" cellspacing="2" width="400">
<tbody>
<tr>
<td> </td>
<td> Mchirp 0 - 3.48 </td>
<td> Mchirp 3.48 - 6.0 </td>
<td> Mchirp 6.0 - 20.0 </td>
</tr>
<tr>
<td> FAP </td>
<td> macroevent1 </td>
<td> macroevent2 </td>
<td> macroevent3 </td>
</tbody>
</table>
<p>
For more details on loudest events see <a href="macrooutdir/loudest_events.txt"> here</a>
</p>'''


usage = ""

parser = OptionParser( usage )

parser.add_option("-r", "--run-directory",action="store",type="string",\
    default=None,\
    help="The location of the run directory")
parser.add_option("-n", "--grb-name",action="store",type="string",\
    default=None,\
    help="Name of the GRB such as 090802")
parser.add_option("-i","--ifo-tag",action="store",type="string",\
    default=None,\
    help="The ifo tag, H1L1 or H1L1V1 for instance")
parser.add_option("-o", "--output-path",action="store",type="string",\
    default='.',\
    help="Output path for plots")
parser.add_option("-O", "--open-box",action="store_true",default=False,
    dest="open_box",help = "Use to show onsource results")

injList = 'injectionsTaylorFaceOn','injectionsTaylorFull','injectionsPPNFull','injectionsSpin1Full'

(opts,args) = parser.parse_args()
opts.output_path = opts.output_path + '/'
if not os.path.isdir(opts.output_path):
  print "--output-path does not exist. How can I make a summary page when I cannot find the plots?"
  sys.exit(1)

if not opts.run_directory:
  print "must provide run directory"
  sys.exit(1)

if not opts.grb_name:
  print "must provide GRB name"
  sys.exit(1)

if not opts.ifo_tag:
  print "must provide ifo tag"
  sys.exit(1)

ifo_tag = opts.ifo_tag
ifos = []

while ifo_tag:
  ifos.append(ifo_tag[0:2])
  ifo_tag = ifo_tag[2:]

ext_trigs = grbsummary.load_external_triggers(opts.run_directory + '/triggerGRB'+opts.grb_name+'.xml')

htmlPageConts = []
curr_html = html_part_1_template
curr_html=curr_html.replace('macrogrbname',opts.grb_name)
curr_html=curr_html.replace('macrogpstime',str(ext_trigs[0].start_time))
d = date.XLALGPSToUTC(date.XLALINT8NSToGPS(ext_trigs[0].start_time*1.0e+9))
month=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug',\
         'Sep','Oct','Nov','Dec']
date_text = '%s %02d %d %02d:%02d:%02d' %\
       (month[d[1]-1], d[2], d[0], d[3], d[4], d[5])
curr_html=curr_html.replace('macrogrbdate',date_text)
curr_html=curr_html.replace('macrorightascension','%.2f'%(ext_trigs[0].event_ra))
curr_html=curr_html.replace('macrodeclination','%.2f'%(ext_trigs[0].event_dec))
curr_html=curr_html.replace('macroifostring',opts.ifo_tag)
ifos = 'H1','L1','V1'
macros = 'macrohresponse','macrolresponse','macrovresponse'
for ifo,macro in zip(ifos,macros):
  f_plus, f_cross, f_ave, f_q = antenna.response( ext_trigs[0].start_time, 
                              ext_trigs[0].event_ra, ext_trigs[0].event_dec,\
                              0.0, 0.0, 'degree',ifo )
  curr_html=curr_html.replace(macro,'%.2f'%f_q)
htmlPageConts.append(curr_html)

curr_html = html_part_2_template
ifoTable = []
ifoPlots = []
for ifo in ifos:
  ifoTab = '<td> %s SNR </td>' %(ifo)
  ifoPlot = trig_plot_tmplt
  ifoPlot=ifoPlot.replace('macroifo',ifo)
  ifoTable.append(ifoTab)
  ifoPlots.append(ifoPlot)
curr_html=curr_html.replace('macroifolist','\n'.join(ifoTable))
curr_html=curr_html.replace('macroifoplots','\n'.join(ifoPlots))
curr_html=curr_html.replace('macrooutdir','./')
curr_html=curr_html.replace('macrogrbname',opts.grb_name)
htmlPageConts.append(curr_html)

curr_html = html_part_3_template
injTable = []
plotmacros = ['macroschisquared','macrobankveto','macroautoveto','macronull1']
plotnames = ['chi_square_vs_snr_zoom','bank_veto_vs_snr_zoom','auto_veto_vs_snr_zoom','null_stat_vs_snr_zoom']
for inj in injList:
  injTable.append('<td> %s </td>' %(inj))
for macro,name in zip(plotmacros,plotnames):
  plot_html =[]
  for inj in injList:
    currPlot = sbv_plot_tmplt
    currPlot=currPlot.replace('macrooutdir','./' + inj)
    currPlot=currPlot.replace('macroplotname',name)
    plot_html.append(currPlot)
  curr_html = curr_html.replace(macro,'\n'.join(plot_html))
snrs_html = []
for ifo in ifos:
  currIfoSNR = ifo_snr_sec_tmplt
  currIfoSNR = currIfoSNR.replace('macroifo',ifo)
  plot_html = []
  name = ifo + '_snr_vs_snr_zoom'
  for inj in injList:
    currPlot = sbv_plot_tmplt
    currPlot=currPlot.replace('macrooutdir','./' + inj)
    currPlot=currPlot.replace('macroplotname',name)
    plot_html.append(currPlot)
  currIfoSNR = currIfoSNR.replace('macrosnrifoplots','\n'.join(plot_html))
  snrs_html.append(currIfoSNR)
curr_html = curr_html.replace('macrosnrplots','\n'.join(snrs_html))
curr_html = curr_html.replace('macroinjlist','\n'.join(injTable))
curr_html = curr_html.replace('macrogrbname',opts.grb_name)
htmlPageConts.append(curr_html)

curr_html = html_part_4_template
injTable = []
injPlotsOne = []
injPlotsTwo = []
injPlotsThree = []
injPlotsFour = []
injPlotsFive = []
injPlotsSix = []
injCloseMissed = []
for inj in injList:
  injTable.append('<td> %s </td>' %(inj))
  injPlotOne = inj_plot_one_tmplt
  injPlotOne =injPlotOne.replace('macroinjdir',inj)
  injPlotOne = injPlotOne.replace('macroifo','h')
  injPlotTwo = inj_plot_two_tmplt
  injPlotTwo =injPlotTwo.replace('macroinjdir',inj)
  injPlotTwo = injPlotTwo.replace('macroifo','h')
  injPlotThree = inj_plot_one_tmplt
  injPlotThree =injPlotThree.replace('macroinjdir',inj)
  injPlotThree = injPlotThree.replace('macroifo','l')
  injPlotFour = inj_plot_two_tmplt
  injPlotFour =injPlotFour.replace('macroinjdir',inj)
  injPlotFour = injPlotFour.replace('macroifo','l')
  injPlotFive = inj_plot_one_tmplt
  injPlotFive =injPlotFive.replace('macroinjdir',inj)
  injPlotFive = injPlotFive.replace('macroifo','v')
  injPlotSix = inj_plot_two_tmplt
  injPlotSix =injPlotSix.replace('macroinjdir',inj)
  injPlotSix = injPlotSix.replace('macroifo','v')
  injCM = cmi_tmplt
  injCM = cmi_tmplt.replace('macroinjdir',inj)
  injPlotsOne.append(injPlotOne)
  injPlotsTwo.append(injPlotTwo)
  injPlotsThree.append(injPlotThree)
  injPlotsFour.append(injPlotFour)
  injPlotsFive.append(injPlotFive)
  injPlotsSix.append(injPlotSix)
  injCloseMissed.append(injCM)
curr_html = curr_html.replace('macroinjlist','\n'.join(injTable))
curr_html = curr_html.replace('macroinjplotone','\n'.join(injPlotsOne))
curr_html = curr_html.replace('macroinjplottwo','\n'.join(injPlotsTwo))
curr_html = curr_html.replace('macroinjplotthree','\n'.join(injPlotsThree))
curr_html = curr_html.replace('macroinjplotfour','\n'.join(injPlotsFour))
curr_html = curr_html.replace('macroinjplotfive','\n'.join(injPlotsFive))
curr_html = curr_html.replace('macroinjplotsix','\n'.join(injPlotsSix))
curr_html = curr_html.replace('macrocmi','\n'.join(injCloseMissed))
curr_html=curr_html.replace('macrooutdir','./')
htmlPageConts.append(curr_html)

curr_html = html_part_5_template
curr_html =curr_html.replace('macrooutdir','./')
htmlPageConts.append(curr_html)

trials = ['OFFTRIAL_1','OFFTRIAL_2','OFFTRIAL_3','OFFTRIAL_4','OFFTRIAL_5','OFFTRIAL_6']
if opts.open_box:
  trials.append('ONSOURCE')

for trial in trials:
  curr_html = html_trial_template
  curr_html = curr_html.replace('macrotrial',trial)
  curr_html = curr_html.replace('macrooutdir','./'+trial)
  file = open(opts.output_path + '/'+trial+'/loud_numbers.txt')
  FAPS = []
  for line in file:
    line = line.replace('\n','')
    if float(line) == -2:
      FAPS.append('No event')
    else:
      FAPS.append(float(line))
  curr_html = curr_html.replace('macroevent1',str(FAPS[0]))
  curr_html = curr_html.replace('macroevent2',str(FAPS[1]))
  curr_html = curr_html.replace('macroevent3',str(FAPS[2]))
  htmlPageConts.append(curr_html)
  file.close()
   
 
html_out = '\n <hr> \n'.join(htmlPageConts)
file = open(opts.output_path + '/summary.html','w')
file.write(html_out)
file.close()


