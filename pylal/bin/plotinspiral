#!/usr/bin/python

import sys
import os
from optparse import *
import re
import exceptions
import glob
from types import *

from pylal import SnglInspiralUtils
from pylal import SimInspiralUtils
from pylal import SearchSummaryUtils
from glue import lal
from glue import segments
from glue import segmentsUtils

##############################################################################
usage = """
usage: %prog [options] 

Inspiral Plotting Functions

The function reads in triggers from a glob of files and produces several 
different figures.

The plots are

1)  SNR v time.

1)  SNR v CHISQ, linear scale  (requres that the chisq was calculated)

2)  SNR v CHISQ, log scale on both axes

   The chisq threshold can be added to the above plots if the 
     --chisq-threshold, --chisq-delta and --chisq-bins are given

3)  Cumulative Histogram of SNR values
    
4)  Histogram of SNR values

5)  "Normalized" cumulative histogram of SNR values
    The normalization is determined by the maximum total number of triggers,
    calculated from the --maximization-interval and --analyzed-time
    
6)  Histogram of CHISQ values  

7)  Cumulative Histogram of snr/chi values
"""

parser = OptionParser( usage )
parser.add_option("-v","--version",action="store_true",default=False,\
    help="display version information " )
parser.add_option("-f","--figure-name",action="store",type="string",\
    default=None,metavar=" FNAME",\
    help="generate png figures with name FNAME-fig.png")
parser.add_option("-g","--glob",action="store",type="string",\
    default=None, metavar=" GLOB",help="GLOB of trigger files to read" )
parser.add_option("-i", "--input", help="read trigger filenames from input file")
parser.add_option("-t","--title",action="store",type="string",default=None,\
    metavar=" STRING",help="title string for plots")
parser.add_option("-s","--show-plot",action="store_true",default=False,\
    help="display the figures on the terminal" )
parser.add_option("-z","--snr-time",action="store_true",default=False,\
    help="make a plot of snr vs time" )
parser.add_option("-y","--add-vertical-line",action="store",default=None,\
    metavar=" GPS_TIME",type="float",\
    help="add a vertical line at GPS_TIME to the snr vs time plot" )
parser.add_option("-a","--snr-chisq",action="store_true",default=False,\
    help="make a plot of snr vs chisq" )
parser.add_option("-b","--log-snr-chisq",action="store_true",default=False,\
    help="make a log plot of snr vs chisq" )
parser.add_option("-C","--chisq-threshold",action="store",type="float",\
    metavar=" CHISQ_THRESH",\
    help="specify the chisq threshold (so we can add to plot)" )
parser.add_option("-D","--chisq-delta",action="store",type="float",\
    metavar=" CHISQ_DELTA", help="specify the delta param for the chisq " )
parser.add_option("-B","--chisq-bins",action="store",type="int",\
    metavar=" CHISQ_BINS", help="specify the number of chisq bins")
parser.add_option("-c","--cum-hist-snr",action="store_true",default=False,\
    help="cumulative histogram of the snr" )
parser.add_option("-d","--hist-snr",action="store_true",default=False,\
    help="histogram of the snr" )
parser.add_option("-e","--norm-hist-snr",action="store_true",default=False,\
    help="normalized cumulative histogram of the snr" )
parser.add_option("-j","--hist-chisq",action="store_true",default=False,\
    help="histogram of the chisq values" )
parser.add_option("-k","--cum-hist-snr-chi",action="store_true",default=False,\
    help="cumulative histogram of snr/chi" )
parser.add_option("-l","--hist-snr-chi",action="store_true",default=False,\
    help="histogram of snr/chi" )
parser.add_option("-n","--nbins",action="store",type="int",default=10,\
    metavar=" NBINS", help="number of bins for the histogram plots" )
parser.add_option("-m","--maximization-interval",action="store",\
    type="int",default=10,\
    metavar=" MAX_INT", help="maximization interval used (in ms)" )
parser.add_option("-T","--analyzed-time",action="store",type="int",\
    metavar=" SECONDS", help="amount of time analyzed" )
parser.add_option("-V","--veto-file",action="store",type="string",\
    default=None,metavar=" FNAME",\
    help="read in segments from FNAME (assumed segwizard format)")
parser.add_option("-A","--funky-threshold",action="store",type="float",\
    metavar=" FUNKY_THRESH",\
    help="specify the funky stat threshold (so we can add to plot)" )
parser.add_option("-F","--funky-offset",action="store",type="float",\
    metavar=" FUNKY_OFFSET", help="specify the offset in funky stat " )
parser.add_option("-p","--template-bank",action="store",type="string",\
    default=None, metavar=" FILE",help="name of a template bank file")
parser.add_option("-x","--x-min",action="store",type="float",\
    default=None, metavar="XMIN",help="set plot xmin to XMIN")
parser.add_option("-X","--x-max",action="store",type="float",\
    default=None, metavar="XMAX",help="set plot xmax to XMAX")
parser.add_option("-L", "--log-y", action="store_true", default=False,
    help="set the y axis to have a log scale")
parser.add_option("-M","--missed-inj",action="store",type="string",\
    default=None, metavar=" FILE",
    help="file containing missed nearby injection")
parser.add_option("","--min-distance",action="store",type="float",\
    default=None, metavar="EFFDIST",
    help="only look at missed injections closer than EFFDIST")

(opts,args) = parser.parse_args()

# if --version flagged
if opts.version:
  sys.exit(0)

# check at least one trig file was specified
if opts.glob is None and opts.input is None:
  print >>sys.stderr, "Must specify a GLOB of files to read or a LAL cache"
  print >>sys.stderr, "Enter 'plotinspiral --help' for usage"
  sys.exit(1)

if opts.norm_hist_snr and not opts.analyzed_time:
  print >>sys.stderr, "to make the normalized cumulative histogram"
  print >>sys.stderr, "the --analyzed-time must be specified"
  sys.exit(1)

if opts.missed_inj and not opts.min_distance:
  print >>sys.stderr, "both a missed injections file and a maximum"
  print >>sys.stderr, "distance should be specified when following"
  print >>sys.stderr, "up nearby missed injections"
  sys.exit(1)

# Now, use the Agg backend if it's unnecessary to call plot(), then do imports
if not opts.show_plot:
  import matplotlib
  matplotlib.use('Agg')
from pylab import *
from pylal import viz

# determine trigger files
trigFiles = []
if opts.glob is not None:
    trigFiles += glob.glob(opts.glob)
if opts.input is not None:
    trigFiles += [lal.CacheEntry(line).path() for line in open(opts.input)]
if not len(trigFiles):
  print >>sys.stderr, "There are no files in your glob and/or lal cache"
  sys.exit(1)

# an instance of the snglInspiralTable
inspTriggers = SnglInspiralUtils.ReadSnglInspiralFromFiles(trigFiles)
plotsymbols= ['r+','bx','ko']

# read in the template bank if supplied
if opts.template_bank:
  tmpltbank=SnglInspiralUtils.ReadSnglInspiralFromFiles([ opts.template_bank ])

# apply veto if there is one
if opts.veto_file:
  seglist = segmentsUtils.fromsegwizard(open(opts.veto_file))
  inspTriggers = inspTriggers.veto(seglist)

# determine missed injection file
if opts.missed_inj:
  anlayzedsegs = SearchSummaryUtils.GetSegListFromSearchSummaries(trigFiles)

  inspDict = {}
  inspDict["ifo"] = inspTriggers[0].ifo
  missedDict = {}

  missedDict["sim_inspiral"] = SimInspiralUtils.ReadSimInspiralFromFiles(\
      [ opts.missed_inj ])
  missedDict["mis_time"] = viz.readcol(missedDict["sim_inspiral"], \
    "end_time", inspDict["ifo"] )
  missedDict["mis_dist"] = viz.readcol(missedDict["sim_inspiral"], "eff_dist", \
    inspDict["ifo"] )

  followupMissed = {}
  followupMissed["mis_time"] = []
  followupMissed["mis_triggers"] = []
  x = segments.segmentlistdict()
  x["anlayzedsegs"] = segments.segmentlist(anlayzedsegs[inspDict["ifo"]])
  for i in range(len(missedDict["mis_time"])):
    if missedDict["mis_dist"][i] < opts.min_distance:
      thisSegment = segments.segment(missedDict["mis_time"][i] - 10,
                                     missedDict["mis_time"][i] + 10)
      x["missedSeg"] = segments.segmentlist([thisSegment])
      x["overlapSeg"] = x.intersection(["missedSeg", "anlayzedsegs"])
      followupMissed["mis_time"].append(missedDict["mis_time"][i])
      followupMissed["mis_triggers"].append(
          inspTriggers.veto(x["overlapSeg"].__invert__()))

max_snr = max(inspTriggers.get_column('snr'))
min_snr = min(inspTriggers.get_column('snr'))
snr_range = arange( min_snr, max_snr, (max_snr - min_snr)/100  )

if opts.chisq_threshold:
  if not ( opts.chisq_bins and opts.chisq_delta):
    print >>sys.stderr, "when --chisq-threshold is specified, must also give"
    print >>sys.stderr, "the --chisq-bins and --chisq-delta"
    sys.exit(1)
  
  chisq_thresh = opts.chisq_threshold * ( opts.chisq_bins + \
    opts.chisq_delta * snr_range * snr_range )

if opts.funky_threshold:
  if not ( opts.funky_offset):
    print >>sys.stderr, "when --funky-threshold is specified, must also give"
    print >>sys.stderr, "the --funky-offset"
    sys.exit(1)
  
  s3_snr_chi_stat = opts.funky_threshold * ( snr_range * snr_range * \
      snr_range *snr_range ) / ( opts.funky_offset + (snr_range * \
      snr_range) ) 

fig_num = 0
###################################
# plot of snr vs time for missed injections
if opts.missed_inj:
  for injTime,triggers in zip(followupMissed["mis_time"],
       followupMissed["mis_triggers"]):
    fig_num += 1
    figure(fig_num)
    axvline(injTime - int(injTime), linewidth=1, color='r')
    for idx in range(len(triggers)):
      triggers[idx].end_time = triggers[idx].end_time - int(injTime)
    viz.plot_a_v_b(triggers,'end_time','snr','seconds','kx',\
                   output_name = opts.figure_name + '_' + str(int(injTime)),\
                   x_min=opts.x_min,x_max=opts.x_max)

###################################
# plot of snr vs time
if opts.snr_time:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  if opts.add_vertical_line:
    axvline(opts.add_vertical_line - int(opts.add_vertical_line), \
            linewidth=1, color='r')  
    for idx in range(len(inspTriggers)):
      inspTriggers[idx].end_time = inspTriggers[idx].end_time \
                                   - int(opts.add_vertical_line)
    viz.plot_a_v_b(inspTriggers,'end_time','snr','seconds','kx',\
                   output_name = opts.figure_name,x_min=opts.x_min,\
                   x_max=opts.x_max)
  else:
    viz.plot_a_v_b(inspTriggers,'end_time','snr','linear','kx',\
                   output_name = opts.figure_name)

###################################
# plot of snr vs chisq
if opts.snr_chisq:
  fig_num += 1
  figure(fig_num)
  if opts.chisq_threshold:
    plot(snr_range, chisq_thresh)
    hold(True)
  if opts.funky_threshold:
    plot(snr_range, s3_snr_chi_stat, 'r-')
    hold(True)
    
  viz.plot_a_v_b(inspTriggers,'snr','chisq','linear','kx',output_name = opts.figure_name)

###################################
# plot of snr vs chisq
if opts.log_snr_chisq:
  fig_num += 1
  figure(fig_num)
  if opts.chisq_threshold:
    loglog(snr_range, chisq_thresh)
    hold(True)
  if opts.funky_threshold:
    loglog(snr_range, s3_snr_chi_stat, 'r-')
    hold(True)
    
  viz.plot_a_v_b(inspTriggers,'snr','chisq','loglog','kx',output_name = opts.figure_name)

###################################
# cumulative histogram of snr
if opts.cum_hist_snr:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.cumhistcol(inspTriggers,'snr',output_name = opts.figure_name)

###################################
# histogram of snr
if opts.hist_snr:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.histcol(inspTriggers,'snr',opts.nbins,None,opts.figure_name)

###################################
# normalized histogram of snr
if opts.norm_hist_snr:
  max_poss_trigs = (1000 / float (opts.maximization_interval)) * \
    opts.analyzed_time
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.cumhistcol(inspTriggers,'snr',normalization = max_poss_trigs,\
      output_name = opts.figure_name)
  
###################################
# histogram of chisq values
if opts.hist_chisq:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.histcol(inspTriggers,'chisq',opts.nbins,None,opts.figure_name)

###################################
# cumulative histogram of snr
if opts.cum_hist_snr_chi:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.cumhistcol(inspTriggers,'snr_over_chi',output_name = opts.figure_name)

###################################
# histogram of snr
if opts.hist_snr_chi:
  fig_num += 1
  figure(fig_num)
  if opts.log_y:
    ax = subplot(111)
    ax.set_yscale('log')
  viz.histcol(inspTriggers,'snr_over_chi',opts.nbins,None,opts.figure_name)

###################################
# plot the template bank and overlay the triggers
if opts.template_bank:
  fig_num += 1
  figure(fig_num)
  viz.plot_a_v_b(tmpltbank,'mass1','mass2','linear',plot_sym = 'rx')
  viz.plot_a_v_b(inspTriggers,'mass1','mass2','linear',plot_sym = 'ro',\
      output_name = opts.figure_name)

if opts.show_plot:
  show()
