#!/usr/bin/python

import sys
import os
import getopt
import re
import exceptions
import glob
from types import *

from pylab import *
from lgen import readMeta
from lgen import viz

##############################################################################
# help message


def usage():
  msg = """\
Usage: plotinspiral [options]

  SUMMARY:  
  
  Generate a set of summary plots from triggers stored as sngl_inspiral 
  tables in LIGO lightweight format.  The plots are

    1.  SNR v CHISQ
    2.  Cumulative Histogram of SNR values
    3.  Histogram of CHISQ values

  OPTIONS:
  
    -h, --help              display this message
  
    -g, --glob STRING       filename glob, e.g. \"H1-INSPIRAL-*.xml\"
    -f, --figure STRING     generate png figures with name STRING-fig.png
    -t, --title TITLE       title string for plots
    -s, --show              display the figures on the terminal.

"""
  print >> sys.stderr, msg


# grab command line options
shortop = "b:f:g:hst:"
longop = [
  "bins=",
  "figure=",
  "glob=",
  "help",
  "show",
  "title="]

try:
  opts, args = getopt.getopt(sys.argv[1:], shortop, longop)
except getopt.GetoptError:
  print >>sys.stderr, "Error parsing command line"
  print >>sys.stderr, "Enter 'plotburst --help' for usage"
  sys.exit(1)

# defaul values
myGlob = None
myFigure = None
myTitle = "SNR v CHISQ"
showflag = 0
nbins = 10

for o, a in opts:
  if o in ("-h", "--help"):
    usage()
    sys.exit(0)
  elif o in ("-v", "--version"):
    sys.exit(0)
  elif o in ("-b", "--bins"):
    nbins = int(a)
  elif o in ("-g", "--glob"):
    myGlob = a
  elif o in ("-f", "--figure"):
    myFigure = a
  elif o in ("-s", "--show"):
    showflag = 1
  elif o in ("-t", "--title"):
    myTitle = a

if not myGlob:
  print >>sys.stderr, "Bad combination or missing options"
  print >>sys.stderr, "Enter 'plotburst --help' for usage"
  sys.exit(1)

# glob the list of files to read in
myfiles = glob.glob(myGlob);

# an instance of the snglInspiralTable
inspTriggers=readMeta.metaDataTable(myfiles, "sngl_inspiral")

# use the supplied method to convert these columns into numarrays
snr = inspTriggers.mkarray("snr")
chisq = inspTriggers.mkarray("chisq")
  
viz.simpleplot(inspTriggers,"snr","chisq")
hold(True)
x=arange(6.0,10,0.1)
y=0.01*(x*x*x*x)/(1+0.01*x*x)
plot(x,1*y,'b-',x,2*y,'k-',x,3*y,'g-')
hold(False)
axis([6.5,10,0,90])
if myFigure:
  savefig(myFigure + "-snrvchisq.png")


figure() 
n = len(snr)
r = arange(len(snr))
snrsq = sort(snr)
semilogy(snrsq, n - r, 'bv')
xlabel(r'snr', size='x-large')
ylabel(r'Cumulative #', size='x-large')
title(r' ' + myTitle)
grid(True)
if myFigure:
  savefig(myFigure + "-snrhist.png")

figure() 
hist(chisq, nbins)
xlabel(r'chisq', size='x-large')
ylabel(r'Number', size='x-large')
title(r' ' + myTitle)
grid(True)
if myFigure:
  savefig(myFigure + "-chisqhist.png")

if showflag:
  show()


