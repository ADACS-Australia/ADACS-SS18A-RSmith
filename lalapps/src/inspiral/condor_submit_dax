# condor_submit_dax  mydax.dax my_OSG_site

DAX=$1
SITE=$2

DAX_BASE=`echo $DAX | awk -F. '{print $1}'`

wget http://ldas-jobs.ligo.caltech.edu/~bdaudert/sites.xml > sites$$.log  2> sites$$.err

if [ $? -ne 0 ]; then
    echo Sites xml wget failed. Output:
    cat sites$$.log
    echo Error:
    cat sites$$.err
    exit $?
fi

wget http://ldas-jobs.ligo.caltech.edu/~bdaudert/properties.bundle > properties$$.log 2> properties$$.err

if [ $? -ne 0 ]; then
    echo properties  wget failed. Output:
    cat properties$$.log
    echo Error:
    cat properties$$.err
    exit $?
fi

pegasus-plan -Dpegasus.user.properties=property.bundle --dir ./submit_files --sites $2  --output local --dax $DAX --nocleanup > ${DAX_BASE}.pegasus_plan_$$.log 2> ${DAX_BASE}.pegasus_plan_$$.err

if [ $? -ne 0 ]; then
    echo Plan is bad. Output:
    cat ${DAX_BASE}.pegasus_plan_$$.log
    echo Error:
    cat ${DAX_BASE}.pegasus_plan_$$.err
    exit $?
fi

RUN_COMMAND="`grep pegasus-run ${DAX_BASE}.pegasus_plan_$$.log`"

exec $RUN_COMMAND
